var ctrlPaymentGateway={'_sGUID':null,'_UserOnly':![],'_UserName':'','Load':function(sGUID,ConfirmCustomerRegistrationResponse,bTargetParent,options){ctrlPaymentGateway['_sGUID']=sGUID;if(options){var sMessage=null;if(options['UserOnly'])ctrlPaymentGateway['_UserOnly']=!![],ctrlPaymentGateway['_UserName']=options['UserOnly'],$('#payment-gateway-stage1')['html']('Activate\x20user\x20account\x20for\x20'+ctrlPaymentGateway['_UserName']),$('#payment-gateway-stage1-p1')['html']('In\x20order\x20to\x20activate\x20this\x20account,\x20may\x20we\x20please\x20request\x20that\x20you\x20choose\x20the\x20Pay\x20as\x20You\x20Go\x20period\x20and\x20pay\x20via\x20the\x20button\x20below:'),$('#payment-gateway-stage1-p2')['html']('Once\x20your\x20payment\x20has\x20been\x20authorised,\x20this\x20user\x20account\x20will\x20be\x20activated\x20with\x20immediate\x20effect\x20allowing\x20'+ctrlPaymentGateway['_UserName']+'\x20to\x20login\x20immediately.'),options['FreePlan']&&(sMessage='In\x20order\x20to\x20activate\x20this\x20account,\x20may\x20we\x20please\x20request\x20that\x20you\x20confirm\x20using\x20the\x20button\x20below:',$('#payment-gateway-stage1-p1')['text'](sMessage),$('#payment-gateway-stage1-iframe-p')['hide'](),$('#payment-gateway-stage1-p2-action')['text']('confirmation.'),$('#payment-gateway-stage1-free-plan')['show'](),$('#payment-gateway-stage1-p2')['html']('Once\x20you\x20confirm\x20activation,\x20this\x20user\x20account\x20will\x20be\x20be\x20activated\x20with\x20immediate\x20effect\x20allowing\x20'+ctrlPaymentGateway['_UserName']+'\x20to\x20login\x20immediately\x20after\x20receiving\x20an\x20automated\x20e-mail\x20with\x20full\x20login\x20instructions.'));else options['FreePlan']&&(sMessage='In\x20order\x20to\x20activate\x20your\x20account,\x20may\x20we\x20please\x20request\x20that\x20you\x20confirm\x20using\x20the\x20button\x20below:',$('#payment-gateway-stage1-p1')['text'](sMessage),$('#payment-gateway-stage1-iframe-p')['hide'](),$('#payment-gateway-stage1-p2-action')['text']('confirmation.'),$('#payment-gateway-stage1-free-plan')['show']());}bTargetParent=!![],bTargetParent=![];var sTarget=bTargetParent?'_parent':'_blank',sURL=ConfirmCustomerRegistrationResponse['PaymentGatewayURL']+'&target='+sTarget,iFrame=$('#payment-gateway-iframe');!bTargetParent&&window['addEventListener']('message',function(e){var key=e['message']?'message':'data',data=e[key];if(data=='Commenced-Payment-Process')ctrlPaymentGateway['StartWaitingForPayment']();},![]);var parentBody=iFrame['parent'](),iWidth=parentBody['width']()+0x14;iFrame['css']('width',iWidth),iFrame['attr']('src',sURL);var fnChromeKludge=function(){var dialogue=$('#trisys-modal-dialogue'),iTop=parseInt(dialogue['css']('top'));};setTimeout(fnChromeKludge,0x3e8);},'LoadAfterPaymentCompleted':function(sGUID){ctrlPaymentGateway['_sGUID']=sGUID,ctrlPaymentGateway['StartWaitingForPayment']();},'StartWaitingForPayment':function(){$('#payment-gateway-prepayment-click')['hide'](),$('#payment-gateway-postpayment-click')['show'](),ctrlPaymentGateway['ScheduleCheckForPayment']();},'ConfirmFreePlanCommissioning':function(){$('#payment-gateway-prepayment-click')['hide'](),$('#payment-gateway-confirm-free-plan-click')['show']();var payloadObject={},CConfirmedFreePlanRequest={'GUID':ctrlPaymentGateway['_sGUID']};payloadObject['URL']='PaymentGateway/ConfirmedFreePlan',payloadObject['OutboundDataPacket']=CConfirmedFreePlanRequest,payloadObject['InboundDataFunction']=function(CConfirmedFreePlanResponse){if(CConfirmedFreePlanResponse){var bSuccess=CConfirmedFreePlanResponse['Success'];if(bSuccess){$('#payment-gateway-confirm-free-plan-click')['hide'](),$('#payment-gateway-provisioning-start-action')['text']('account\x20activation\x20request'),ctrlPaymentGateway['ScheduleCheckForPayment']();if(ctrlPaymentGateway['_UserOnly'])ctrlPaymentGateway['UserAccountActivatedVisualBlockDisplay']('');}else TriSysApex['UI']['ShowMessage'](CConfirmedFreePlanResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['errorAlert']('ctrlPaymentGateway.ConfirmFreePlanCommissioning:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'ScheduleCheckForPayment':function(){setTimeout(ctrlPaymentGateway['CheckForPayment'],0x3e8);},'CheckForPayment':function(){var payloadObject={},CConfirmPaymentStatusRequest={'GUID':ctrlPaymentGateway['_sGUID']};payloadObject['URL']='PaymentGateway/ConfirmPaymentStatus',payloadObject['OutboundDataPacket']=CConfirmPaymentStatusRequest,payloadObject['InboundDataFunction']=function(CConfirmPaymentStatusResponse){if(CConfirmPaymentStatusResponse){var bSuccess=CConfirmPaymentStatusResponse['Success'];if(bSuccess){var bPaid=CConfirmPaymentStatusResponse['Paid'];if(bPaid){if(CConfirmPaymentStatusResponse['UserAccountActivation'])ctrlPaymentGateway['UserAccountActivated'](CConfirmPaymentStatusResponse);else ctrlPaymentGateway['StartProvisioning']();}else ctrlPaymentGateway['ScheduleCheckForPayment']();}else TriSysApex['UI']['ShowMessage'](CConfirmPaymentStatusResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['errorAlert']('ctrlPaymentGateway.CheckForPayment:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'StartProvisioning':function(){$('#payment-gateway-postpayment-click')['hide'](),$('#payment-gateway-provisioning-start')['show'](),ctrlPaymentGateway['ScheduleCheckForCompletedProvisioning']();},'ScheduleCheckForCompletedProvisioning':function(){setTimeout(ctrlPaymentGateway['CheckForCompletedProvisioning'],0x3a98);},'CheckForCompletedProvisioning':function(fnCallbackIfProvisionedOrNot){var payloadObject={},CProvisioningStatusRequest={'GUID':ctrlPaymentGateway['_sGUID']};payloadObject['URL']='PaymentGateway/ProvisioningStatus',payloadObject['OutboundDataPacket']=CProvisioningStatusRequest,payloadObject['InboundDataFunction']=function(CProvisioningStatusResponse){if(CProvisioningStatusResponse){var bSuccess=CProvisioningStatusResponse['Success'];if(bSuccess){var bProvisioned=CProvisioningStatusResponse['Provisioned'];fnCallbackIfProvisionedOrNot?fnCallbackIfProvisionedOrNot(bProvisioned):bProvisioned?ctrlPaymentGateway['CompletedProvisioning'](CProvisioningStatusResponse):ctrlPaymentGateway['ScheduleCheckForCompletedProvisioning']();}else TriSysApex['UI']['ShowMessage'](CProvisioningStatusResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['errorAlert']('ctrlPaymentGateway.CheckForCompletedProvisioning:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'CompletedProvisioning':function(CProvisioningStatusResponse){$('#payment-gateway-provisioning-start')['hide'](),$('#payment-gateway-provisioning-completed')['show']();var iSeconds=0xb,fnCountdownToLogin=function(){iSeconds-=0x1;var sTime=iSeconds+'\x20second'+(iSeconds==0x1,'','s');$('#payment-gateway-timetillautologin')['html'](sTime);if(iSeconds>0x0)setTimeout(fnCountdownToLogin,0x3e8);else ctrlPaymentGateway['CommenceLogin'](CProvisioningStatusResponse);};fnCountdownToLogin();},'UserAccountActivatedVisualBlockDisplay'(sUserAccountName){$('#payment-gateway-prepayment-click')['hide'](),$('#payment-gateway-postpayment-click')['hide'](),$('#payment-gateway-provisioning-start')['hide'](),$('#payment-gateway-provisioning-completed')['show']();if(sUserAccountName['length']>0x0)sUserAccountName+='\x20';$('#payment-gateway-provisioning')['html']('The\x20user\x20account\x20'+sUserAccountName+'is\x20now\x20being\x20activated'),$('#payment-gateway-provisioning-p2')['hide'](),$('#payment-gateway-provisioning-p4')['html']('Once\x20this\x20has\x20been\x20completed,\x20the\x20user\x20list\x20will\x20be\x20refreshed.'),$('#payment-gateway-provisioning-spinner')['show']();},'UserAccountActivated':function(CConfirmPaymentStatusResponse){ctrlPaymentGateway['UserAccountActivatedVisualBlockDisplay'](CConfirmPaymentStatusResponse['UserAccountName']);try{subscriptionPaid['UserAccountProvisioning'](CConfirmPaymentStatusResponse['UserAccountName']);}catch(e){}var fnCommenceLogin=function(bProvisioned){if(bProvisioned){TriSysApex['UI']['CloseModalPopup'](),AdminConsole['PopulateUserGrid']();if(CConfirmPaymentStatusResponse['UserAccountActivation']){var bThisUserAccount=ctrlPaymentGateway['isThisUserAccount'](CConfirmPaymentStatusResponse['UserId']),bAdminConsoleOpen=TriSysApex['FormsManager']['isFormOpen']('AdminConsole');if(!bThisUserAccount&&bAdminConsoleOpen)return;}var fnRefreshLogin=function(){ctrlPaymentGateway['CommenceLogin'](CConfirmPaymentStatusResponse);};if(TriSysWeb['Security']['IsUserLoggedIn']()){var sLogoffMessage='You\x20re-activated\x20your\x20own\x20account.\x20Refresh\x20login?';TriSysApex['UI']['questionYesNo'](sLogoffMessage,'Logoff\x20'+TriSysApex['Copyright']['ShortProductName'],'Yes',fnRefreshLogin,'No');}else fnRefreshLogin();}else setTimeout(fnCheckForCompletedProvisioning,0x3e8);},fnCheckForCompletedProvisioning=function(){ctrlPaymentGateway['CheckForCompletedProvisioning'](fnCommenceLogin);};fnCommenceLogin(![]);},'isThisUserAccount':function(lUserId){var userCredentials=TriSysApex['LoginCredentials']['UserCredentials']();if(userCredentials){if(userCredentials['LoggedInUser']){if(userCredentials['LoggedInUser']['UserId']===lUserId)return!![];}}return![];},'CommenceLogin':function(CProvisioningStatusResponse){TriSysApex['UI']['CloseModalPopup']();var sURL='https://apex.trisys.co.uk/#supportlogin~'+CProvisioningStatusResponse['Base64SupportCredentials'];window['location']=sURL;}};