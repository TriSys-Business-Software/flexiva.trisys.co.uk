var ctrlContractRate={'Load':function(){var context=TriSysApex['ModalDialogue']['ContractRates']['Context'],bExistingRate=context['RecordId']>0x0&&context['RateId']>0x0;if(context['EntityName']=='Company'){$('#contractRate-CompanyJobTitleAndAddressTable')['show']();var sField='contractRate-CompanyAddress';TriSysApex['ModalDialogue']['CompanyAddresses']['PopulateCombo'](context['RecordId'],sField);}var fSpinIncrement=0.25,sPeriod='Hour';TriSysSDK['Controls']['CurrencyAmountPeriod']['PopulateCurrencyAmountPeriodWidget']('contractRate-PayRate',fSpinIncrement,sPeriod),TriSysSDK['Controls']['CurrencyAmountPeriod']['PopulateCurrencyAmountPeriodWidget']('contractRate-ChargeRate',fSpinIncrement,sPeriod),TriSysSDK['Controls']['CurrencyAmountPeriod']['PopulateCurrencyAmountPeriodWidget']('contractRate-PAYE',fSpinIncrement,sPeriod),TriSysSDK['Controls']['CurrencyAmountPeriod']['PopulateCurrencyAmountPeriodWidget']('contractRate-StandardPayRate',fSpinIncrement,sPeriod),TriSysSDK['Controls']['CurrencyAmountPeriod']['PopulateCurrencyAmountPeriodWidget']('contractRate-StandardChargeRate',fSpinIncrement,sPeriod);var fieldDescription={'MinValue':0x0,'MaxValue':0x64,'SpinIncrement':0.25};TriSysSDK['Controls']['NumericSpinner']['Initialise']('contractRate-Multiplier',fieldDescription),TriSysSDK['Controls']['NumericSpinner']['Initialise']('contractRate-MarginPercentage',fieldDescription),TriSysSDK['Controls']['NumericSpinner']['Initialise']('contractRate-MarkupPercentage',fieldDescription),fieldDescription={'MinValue':0x0,'MaxValue':0x7,'SpinIncrement':0.25},TriSysSDK['Controls']['NumericSpinner']['Initialise']('contractRate-DaysPerWeek',fieldDescription),fieldDescription={'MinValue':0x0,'MaxValue':0x18,'SpinIncrement':0.25},TriSysSDK['Controls']['NumericSpinner']['Initialise']('contractRate-HoursPerDay',fieldDescription),fieldDescription={'MinValue':0x0,'MaxValue':0x100,'SpinIncrement':0x1,'Format':'#0.00'},TriSysSDK['Controls']['NumericSpinner']['Initialise']('contractRate-DurationInWeeks',fieldDescription),TriSysSDK['Controls']['CurrencyAmount']['Initialise']('contractRate-Value'),TriSysSDK['Controls']['CurrencyAmount']['Initialise']('contractRate-Profit'),TriSysSDK['Controls']['CurrencyAmount']['Initialise']('contractRate-ValuePerUnit'),ctrlContractRate['CalculationEngine'](),setTimeout(function(){TriSysSDK['Controls']['CurrencyAmountPeriod']['Readonly']('contractRate-StandardPayRate'),TriSysSDK['Controls']['CurrencyAmountPeriod']['Readonly']('contractRate-StandardChargeRate'),TriSysSDK['Controls']['CurrencyAmount']['Readonly']('contractRate-Value'),TriSysSDK['Controls']['CurrencyAmount']['Readonly']('contractRate-Profit'),TriSysSDK['Controls']['CurrencyAmount']['Readonly']('contractRate-ValuePerUnit');if(bExistingRate){}TriSysSDK['Controls']['CurrencyAmountPeriod']['Readonly']('contractRate-PAYE',bExistingRate);},0xfa),!TriSysSDK['CShowForm']['JobTitlesCached']()&&$('#contractRate-JobTitle')['keyup'](function(e){if(e['keyCode']==0xd)ctrlContractRate['JobTitleLookup']();}),ctrlContractRate['ReadFromWebAPI'](context['EntityName'],context['RecordId'],context['RateId']);},'LoadRateTypeCombo':function(sEntityName,sDiv,bExistingRate,availableTypes){if(availableTypes){var sourceSkills=[],sDefault=null;for(var i=0x0;i<availableTypes['length'];i++){var availableType=availableTypes[i],sourceStruct={'value':availableType,'text':availableType};sourceSkills['push'](sourceStruct);if(!sDefault)sDefault=availableType;}TriSysSDK['CShowForm']['populateComboFromDataSource'](sDiv,sourceSkills);if(sDefault)TriSysSDK['CShowForm']['SetTextInCombo'](sDiv,sDefault);}else TriSysSDK['CShowForm']['skillCombo'](sDiv,ctrlContractRate['GetSkillCategory'](),null);if(bExistingRate)TriSysSDK['CShowForm']['ComboEnabled']('contractRate-Type',![]);},'GetSkillCategory':function(){var context=TriSysApex['ModalDialogue']['ContractRates']['Context'],sEntityName=context['EntityName'],sSkillCategory=sEntityName=='Placement'?'RateType':'RequirementRateType';return sSkillCategory;},'RateTypeChange':function(sRateType){var sCategory=ctrlContractRate['GetSkillCategory'](),skills=TriSysApex['Cache']['Skills']();for(var i=0x0;i<skills['length'];i++){var skill=skills[i];if(skill['Category']==sCategory&&skill['Skill']==sRateType){$('#contractRate-Notes')['val'](skill['Description']);break;}}ctrlContractRate['AfterRateTypeChange'](sRateType);},'AfterRateTypeChange':function(sRateType){var bStandard=sRateType=='Standard',context=TriSysApex['ModalDialogue']['ContractRates']['Context'],bCompanyRate=context['EntityName']=='Company';if(bStandard){$('#contractRate-Multiplier-Row')['hide'](),$('#contractRate-StandardPayRate-Row')['hide'](),$('#contractRate-StandardChargeRate-Row')['hide']();if(!bCompanyRate)$('#contractRate-PlacementValuesTable')['show']();}else{$('#contractRate-Multiplier-Row')['show'](),$('#contractRate-StandardPayRate-Row')['show'](),$('#contractRate-StandardChargeRate-Row')['show']();if(!bCompanyRate)$('#contractRate-PlacementValuesTable')['hide']();}},'CalculationEngine':function(sFieldID,fValue){var sPayRate=TriSysSDK['Controls']['CurrencyAmountPeriod']['GetCurrencyAmountPeriod']('contractRate-PayRate'),sChargeRate=TriSysSDK['Controls']['CurrencyAmountPeriod']['GetCurrencyAmountPeriod']('contractRate-ChargeRate'),sCurrency=TriSysSDK['Controls']['CurrencyAmountPeriod']['GetCurrency']('contractRate-ChargeRate'),fPayRateAmount=TriSysSDK['Controls']['CurrencyAmountPeriod']['GetAmount']('contractRate-PayRate'),fChargeRateAmount=TriSysSDK['Controls']['CurrencyAmountPeriod']['GetAmount']('contractRate-ChargeRate'),fMarginPercentage=0x0,fMarkupPercentage=0x0,fMultiplier=TriSysSDK['Controls']['NumericSpinner']['GetValue']('contractRate-Multiplier');if(sFieldID&&sFieldID['indexOf']('contractRate-Multiplier')==0x0){var fStandardPayRateAmount=TriSysSDK['Controls']['CurrencyAmountPeriod']['GetAmount']('contractRate-StandardPayRate'),fStandardChargeRateAmount=TriSysSDK['Controls']['CurrencyAmountPeriod']['GetAmount']('contractRate-StandardChargeRate');fPayRateAmount=fMultiplier*fStandardPayRateAmount,fChargeRateAmount=fMultiplier*fStandardChargeRateAmount,TriSysSDK['Controls']['CurrencyAmountPeriod']['SetAmount']('contractRate-PayRate',fPayRateAmount),TriSysSDK['Controls']['CurrencyAmountPeriod']['SetAmount']('contractRate-ChargeRate',fChargeRateAmount);}if(sFieldID&&sFieldID['indexOf']('contractRate-MarginPercentage')==0x0){var bUpdateChargeRateCalculation=TriSysSDK['CShowForm']['CheckBoxValue']('contractRate-UpdateChargeRateCalculation');fMarginPercentage=TriSysSDK['Controls']['NumericSpinner']['GetValue']('contractRate-MarginPercentage'),fMarkupPercentage=TriSysSDK['Controls']['NumericSpinner']['GetValue']('contractRate-MarkupPercentage'),bUpdateChargeRateCalculation?(fChargeRateAmount=fPayRateAmount/(0x1-fMarginPercentage/0x64),TriSysSDK['Controls']['CurrencyAmountPeriod']['SetAmount']('contractRate-ChargeRate',fChargeRateAmount)):(fPayRateAmount=fChargeRateAmount-fChargeRateAmount*(fMarginPercentage/0x64),TriSysSDK['Controls']['CurrencyAmountPeriod']['SetAmount']('contractRate-PayRate',fPayRateAmount));}var fMarginAmount=fChargeRateAmount-fPayRateAmount;if(fChargeRateAmount!=0x0)fMarginPercentage=fMarginAmount/fChargeRateAmount*0x64;if(fPayRateAmount!=0x0)fMarkupPercentage=fMarginAmount/fPayRateAmount*0x64;var fStandardPayRate=TriSysSDK['Controls']['CurrencyAmountPeriod']['GetCurrencyAmountPeriodPerHour']('contractRate-StandardPayRate');if(fStandardPayRate!=0x0)fMultiplier=fPayRateAmount/fStandardPayRate;var bMarginMarkupCalculation=TriSysSDK['CShowForm']['CheckBoxValue']('contractRate-MarginMarkupCalculation');bMarginMarkupCalculation&&(TriSysSDK['Controls']['NumericSpinner']['SetValue']('contractRate-MarginPercentage',fMarginPercentage),TriSysSDK['Controls']['NumericSpinner']['SetValue']('contractRate-MarkupPercentage',fMarkupPercentage));var bStandard=TriSysSDK['CShowForm']['GetTextFromCombo']('contractRate-Type')=='Standard';if(bStandard){var fDaysPerWeek=TriSysSDK['Controls']['NumericSpinner']['GetValue']('contractRate-DaysPerWeek'),fHoursPerDay=TriSysSDK['Controls']['NumericSpinner']['GetValue']('contractRate-HoursPerDay'),iDurationWeeks=TriSysSDK['Controls']['NumericSpinner']['GetValue']('contractRate-DurationInWeeks'),fValuePerUnit=fChargeRateAmount-fPayRateAmount,sPeriod=TriSysSDK['Controls']['CurrencyAmountPeriod']['GetPeriod']('contractRate-ChargeRate');switch(sPeriod){case'Hour':fTotalValue=fChargeRateAmount*fDaysPerWeek*fHoursPerDay*iDurationWeeks,fProfit=fMarginAmount*fDaysPerWeek*fHoursPerDay*iDurationWeeks;break;case'Day':fTotalValue=fChargeRateAmount*fDaysPerWeek*iDurationWeeks,fProfit=fMarginAmount*fDaysPerWeek*iDurationWeeks;break;case'Week':fTotalValue=fChargeRateAmount*iDurationWeeks,fProfit=fMarginAmount*iDurationWeeks;break;case'Month':fTotalValue=fChargeRateAmount*iDurationWeeks/0x4,fProfit=fMarginAmount*iDurationWeeks/0x4;break;case'Annum':fTotalValue=fChargeRateAmount*iDurationWeeks/0x34,fProfit=fMarginAmount*iDurationWeeks/0x34;break;}TriSysSDK['Controls']['CurrencyAmount']['SetCurrencyAmount']('contractRate-Value',sCurrency+fTotalValue),TriSysSDK['Controls']['CurrencyAmount']['SetCurrencyAmount']('contractRate-Profit',sCurrency+fProfit),TriSysSDK['Controls']['CurrencyAmount']['SetCurrencyAmount']('contractRate-ValuePerUnit',sCurrency+fValuePerUnit);}},'ReadFromWebAPI':function(sEntityName,lEntityId,lRateId){var CReadRateRequest={'EntityName':sEntityName,'EntityId':lEntityId,'RateId':lRateId},payloadObject={};payloadObject['URL']='Rates/Read',payloadObject['OutboundDataPacket']=CReadRateRequest,payloadObject['InboundDataFunction']=function(data){TriSysApex['UI']['HideWait']();var CReadRateResponse=data;if(CReadRateResponse){if(CReadRateResponse['Success']){var bExistingRate=CReadRateResponse['RateId']>0x0,bCompanyRate=sEntityName=='Company';if(bCompanyRate){if(CReadRateResponse['JobTitle'])$('#contractRate-JobTitle')['val'](CReadRateResponse['JobTitle']);if(CReadRateResponse['AddressId']>0x0)TriSysSDK['CShowForm']['SetValueInCombo']('contractRate-CompanyAddress',CReadRateResponse['AddressId']);bExistingRate&&($('#contractRate-JobTitle')['prop']('disabled',!![]),$('#contractRate-JobTitle-Lookup')['attr']('disabled',!![]),TriSysSDK['CShowForm']['ComboEnabled']('contractRate-CompanyAddress',![]));}ctrlContractRate['LoadRateTypeCombo'](sEntityName,'contractRate-Type',bExistingRate,CReadRateResponse['AvailableRateTypeList']),TriSysSDK['CShowForm']['SetTextInCombo']('contractRate-Type',CReadRateResponse['RateType']),$('#contractRate-Notes')['val'](CReadRateResponse['Notes']),TriSysSDK['Controls']['CurrencyAmountPeriod']['SetCurrencyAmountPeriod']('contractRate-PayRate',CReadRateResponse['PayRate']),TriSysSDK['Controls']['CurrencyAmountPeriod']['SetCurrencyAmountPeriod']('contractRate-ChargeRate',CReadRateResponse['ChargeRate']),TriSysSDK['Controls']['CurrencyAmountPeriod']['SetCurrencyAmountPeriod']('contractRate-PAYE',CReadRateResponse['PAYE']),TriSysSDK['Controls']['CurrencyAmountPeriod']['SetCurrencyAmountPeriod']('contractRate-StandardPayRate',CReadRateResponse['StandardPayRate']),TriSysSDK['Controls']['CurrencyAmountPeriod']['SetCurrencyAmountPeriod']('contractRate-StandardChargeRate',CReadRateResponse['StandardChargeRate']),TriSysSDK['Controls']['NumericSpinner']['SetValue']('contractRate-MarginPercentage',CReadRateResponse['Margin']),TriSysSDK['Controls']['NumericSpinner']['SetValue']('contractRate-MarkupPercentage',CReadRateResponse['Markup']),TriSysSDK['Controls']['NumericSpinner']['SetValue']('contractRate-DaysPerWeek',CReadRateResponse['DaysPerWeek']),TriSysSDK['Controls']['NumericSpinner']['SetValue']('contractRate-HoursPerDay',CReadRateResponse['HoursPerDay']),TriSysSDK['Controls']['NumericSpinner']['SetValue']('contractRate-DurationInWeeks',CReadRateResponse['DurationInWeeks']),TriSysSDK['Controls']['NumericSpinner']['SetValue']('contractRate-Multiplier',CReadRateResponse['Multiplier']),ctrlContractRate['AfterRateTypeChange'](CReadRateResponse['RateType']),ctrlContractRate['CalculationEngine']();return;}else TriSysApex['UI']['ShowMessage'](CReadRateResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['HideWait'](),TriSysApex['UI']['errorAlert']('ctrlContractRate.ReadFromWebAPI:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysApex['UI']['ShowWait'](null,'Reading\x20Rate...'),TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'AddNewButtonClick':function(){var fnAfterSave=function(lRateId){var context=TriSysApex['ModalDialogue']['ContractRates']['Context'];context['RateId']=0x0;var sRateType=TriSysSDK['CShowForm']['GetTextFromCombo']('contractRate-Type'),bStandard=sRateType=='Standard';if(bStandard){var fPayRateAmount=TriSysSDK['Controls']['CurrencyAmountPeriod']['GetAmount']('contractRate-PayRate'),fChargeRateAmount=TriSysSDK['Controls']['CurrencyAmountPeriod']['GetAmount']('contractRate-ChargeRate');TriSysSDK['Controls']['CurrencyAmountPeriod']['SetAmount']('contractRate-StandardPayRate',fPayRateAmount),TriSysSDK['Controls']['CurrencyAmountPeriod']['SetAmount']('contractRate-StandardChargeRate',fChargeRateAmount);}TriSysSDK['CShowForm']['RemoveComboItem']('contractRate-Type',sRateType),$('#contractRate-Notes')['val'](''),TriSysSDK['CShowForm']['ComboEnabled']('contractRate-Type',!![]),TriSysSDK['Controls']['CurrencyAmountPeriod']['Readonly']('contractRate-PAYE',![]);};ctrlContractRate['SaveRate'](fnAfterSave);},'SaveButtonClick':function(){var fnAfterSave=function(lRateId){TriSysApex['UI']['CloseModalPopup']();};ctrlContractRate['SaveRate'](fnAfterSave);},'SaveRate':function(fnCallback){var context=TriSysApex['ModalDialogue']['ContractRates']['Context'],CWriteRateRequest={'EntityName':context['EntityName'],'EntityId':context['RecordId'],'JobTitle':$('#contractRate-JobTitle')['val'](),'AddressId':TriSysSDK['CShowForm']['GetValueFromCombo']('contractRate-CompanyAddress'),'RateId':context['RateId'],'RateType':TriSysSDK['CShowForm']['GetTextFromCombo']('contractRate-Type'),'Notes':$('#contractRate-Notes')['val'](),'PayRate':TriSysSDK['Controls']['CurrencyAmountPeriod']['GetCurrencyAmountPeriod']('contractRate-PayRate'),'ChargeRate':TriSysSDK['Controls']['CurrencyAmountPeriod']['GetCurrencyAmountPeriod']('contractRate-ChargeRate'),'PAYE':TriSysSDK['Controls']['CurrencyAmountPeriod']['GetCurrencyAmountPeriod']('contractRate-PAYE'),'Margin':TriSysSDK['Controls']['NumericSpinner']['GetValue']('contractRate-MarginPercentage'),'Markup':TriSysSDK['Controls']['NumericSpinner']['GetValue']('contractRate-MarkupPercentage'),'DaysPerWeek':TriSysSDK['Controls']['NumericSpinner']['GetValue']('contractRate-DaysPerWeek'),'HoursPerDay':TriSysSDK['Controls']['NumericSpinner']['GetValue']('contractRate-HoursPerDay'),'DurationInWeeks':TriSysSDK['Controls']['NumericSpinner']['GetValue']('contractRate-DurationInWeeks'),'Multiplier':TriSysSDK['Controls']['NumericSpinner']['GetValue']('contractRate-Multiplier'),'Value':TriSysSDK['Controls']['CurrencyAmount']['GetCurrencyAmount']('contractRate-Value'),'Profit':TriSysSDK['Controls']['CurrencyAmount']['GetCurrencyAmount']('contractRate-Profit'),'ValuePerUnit':TriSysSDK['Controls']['CurrencyAmount']['GetCurrencyAmount']('contractRate-ValuePerUnit')},bCompanyRate=context['EntityName']=='Company',fPayRateAmount=TriSysSDK['Controls']['CurrencyAmountPeriod']['GetAmount']('contractRate-PayRate'),fChargeRateAmount=TriSysSDK['Controls']['CurrencyAmountPeriod']['GetAmount']('contractRate-ChargeRate'),bWarningOnValidationOnly=![],bEnforcePayRateGreaterThanChargeRate=TriSysAPI['Operators']['stringToBoolean'](TriSysApex['Cache']['SystemSettingManager']['GetValue']('Enforce\x20Pay\x20Rate\x20Greater\x20Than\x20Charge\x20Rate',!![]));if(!bEnforcePayRateGreaterThanChargeRate)bWarningOnValidationOnly=!![];var bError=![];if(CWriteRateRequest['RateId']==0x0){if(bCompanyRate){var sAddress=TriSysSDK['CShowForm']['GetTextFromCombo']('contractRate-CompanyAddress');if(!CWriteRateRequest['JobTitle']||CWriteRateRequest['JobTitle']=='-')bError=TriSysApex['Toasters']['ErrorValidatingField']('Job\x20Title');if(!sAddress)bError=TriSysApex['Toasters']['ErrorValidatingField']('Company\x20Address');}}if(CWriteRateRequest['RateType']=='--\x20Please\x20Select\x20--')bError=TriSysApex['Toasters']['ErrorValidatingField']('Rate\x20Type');if(fPayRateAmount<=0x0){if(!bWarningOnValidationOnly)bError=TriSysApex['Toasters']['ErrorValidatingField']('Pay\x20Rate');}if(fChargeRateAmount<=0x0){if(!bWarningOnValidationOnly)bError=TriSysApex['Toasters']['ErrorValidatingField']('Charge\x20Rate');}if(fPayRateAmount>=fChargeRateAmount){if(bWarningOnValidationOnly){var fnSaveAnyway=function(){return ctrlContractRate['SendRateChangeToWebAPI'](CWriteRateRequest,context,fnCallback),!![];},sMessage='The\x20Pay\x20Rate\x20is\x20equal\x20to\x20or\x20less\x20than\x20the\x20Charge\x20Rate.\x20Do\x20you\x20want\x20to\x20continue?';TriSysApex['UI']['questionYesNo'](sMessage,'Rate\x20Validation','Yes',fnSaveAnyway,'No');return;}else bError=TriSysApex['Toasters']['ErrorValidatingMessage']('Charge\x20rate\x20must\x20be\x20higher\x20than\x20pay\x20rate');}if(bError)return;ctrlContractRate['SendRateChangeToWebAPI'](CWriteRateRequest,context,fnCallback);},'SendRateChangeToWebAPI':function(CWriteRateRequest,context,fnCallback){var payloadObject={};payloadObject['URL']='Rates/Write',payloadObject['OutboundDataPacket']=CWriteRateRequest,payloadObject['InboundDataFunction']=function(CWriteRateResponse){TriSysApex['UI']['HideWait']();if(CWriteRateResponse){if(CWriteRateResponse['Success']){TriSysSDK['Grid']['ClearCheckedRows'](context['Grid']),TriSysSDK['Grid']['RefreshData'](context['Grid']),ctrlContractRate['SynchroniseStandard'](CWriteRateRequest,context),fnCallback(CWriteRateResponse['RateId']);return;}else TriSysApex['UI']['ShowMessage'](CWriteRateResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['HideWait'](),TriSysApex['UI']['errorAlert']('ctrlContractRate.SendRateChangeToWebAPI:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysApex['UI']['ShowWait'](null,'Saving\x20Rate...'),TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'SynchroniseStandard':function(CWriteRateRequest,context){var bStandard=CWriteRateRequest['RateType']=='Standard';bStandard&&((context['EntityName']=='Requirement'||context['EntityName']=='Placement')&&(TriSysSDK['Controls']['NumericSpinner']['SetValue'](context['EntityName']+'ConfigFields_DurationInWeeks',CWriteRateRequest['DurationInWeeks']),TriSysSDK['Controls']['NumericSpinner']['SetValue'](context['EntityName']+'ConfigFields_HoursPerDay',CWriteRateRequest['HoursPerDay']),TriSysSDK['Controls']['NumericSpinner']['SetValue'](context['EntityName']+'ConfigFields_DaysPerWeek',CWriteRateRequest['DaysPerWeek'])));},'JobTitleLookup':function(){var sJobTitleField='contractRate-JobTitle',sJobTitle=TriSysSDK['CShowForm']['GetJobTitleFromField'](sJobTitleField);TriSysSDK['JobTitle']['Lookup'](sJobTitle,sJobTitleField);}};$(document)['ready'](function(){ctrlContractRate['Load']();});