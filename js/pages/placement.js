var ctrlPlacementForm={'Load':function(){TriSysSDK['EntityFormTabs']['AddClickEventHandlers']('placement-form-tab-nav-horizontal',!![]),TriSysSDK['Controls']['Button']['Click']('placement-form-tab-contract');var hideMenuItemPrefixes=['file-menu-saveas'];if(TriSysApex['Device']['isPhone']())$('#placementForm-ActionsMenu')['hide']();else{var sCallbackFunction='ctrlPlacementForm.ActionInvocation',sMasterEntityCallbackFunction='ctrlPlacementForm.ActionInvocationMasterEntity';TriSysActions['Menus']['Draw']('placementForm-ActionsMenu','Placement',sCallbackFunction),TriSysSDK['FormMenus']['DrawGridMenu']('placementLineManagerGridMenu','placementForm-LineManagerGrid'),TriSysSDK['FormMenus']['DrawGridMenu']('placementTimesheetsGridMenu','placementForm-TimesheetGrid'),TriSysActions['Menus']['Draw']('placementTimesheetsActionsMenu','Timesheet',sCallbackFunction,sMasterEntityCallbackFunction);}var sGrid='placementForm-NotesHistoryGrid';TriSysSDK['FormMenus']['DrawGridMenu']('placementNotesHistoryGridMenu',sGrid),sGrid='placementForm-ScheduledTasksGrid',TriSysSDK['FormMenus']['DrawGridMenu']('placementScheduledTasksGridMenu',sGrid);var fnCallbackAfterLoadingSalary=function(){TriSysSDK['CShowForm']['CustomFieldsTab']['Load']('placement-form-customfields','placement-form-tab-custom-caption','Placement'),TriSysSDK['CShowForm']['InitialiseFields']('Placement');};TriSysSDK['PermanentSalary']['Load']('Placement',TriSysApex['Pages']['PlacementForm']['PlacementId'],'placement-form-permanent-salary',fnCallbackAfterLoadingSalary),!TriSysSDK['CShowForm']['JobTitlesCached']()&&($('#tr-PlacementConfigFields_JobTitle')['show'](),$('#PlacementConfigFields_JobTitle')['keyup'](function(e){if(e['keyCode']==0xd)ctrlPlacementForm['JobTitleLookup']();})),TriSysApex['FieldEvents']['AddDateChangeFieldOfInterest']('PlacementConfigFields_StartDate',ctrlPlacementForm['CalculateDurationWeeks']),TriSysApex['FieldEvents']['AddDateChangeFieldOfInterest']('PlacementConfigFields_EndDate',ctrlPlacementForm['CalculateDurationWeeks']);},'TabButtonCallback':function(sTabID){switch(sTabID){case'placement-form-panel-contract':if(TriSysApex['Forms']['EntityForm']['isGridPopulated']('Placement',sTabID))return;TriSysSDK['ContractRates']['Load']('Placement',TriSysApex['Pages']['PlacementForm']['PlacementId'],'placement-form-contract-rates');break;case'placement-form-panel-attributes':if(TriSysApex['Forms']['EntityForm']['isGridPopulated']('Placement',sTabID))return;TriSysSDK['Attributes']['Load']('Placement',TriSysApex['Pages']['PlacementForm']['PlacementId'],'placement-form-attributes');break;case'placement-form-panel-backoffice':if(TriSysApex['Forms']['EntityForm']['isGridPopulated']('Placement',sTabID))return;ctrlPlacementForm['LoadLineManagers']();break;case'placement-form-panel-timesheets':if(TriSysApex['Forms']['EntityForm']['isGridPopulated']('Placement',sTabID))return;TriSysApex['Pages']['PlacementForm']['LoadTimesheetGrid']('placementForm-TimesheetGrid');break;case'placement-form-panel-documentlibrary':if(TriSysApex['Forms']['EntityForm']['isGridPopulated']('Placement',sTabID))return;TriSysSDK['DocumentLibrary']['Load']('Placement',TriSysApex['Pages']['PlacementForm']['PlacementId'],'placement-form-documentlibrary');break;case'placement-form-panel-noteshistory':TriSysApex['Pages']['PlacementForm']['LoadNotesHistoryGrid']('placementForm-NotesHistoryGrid',null);break;case'placement-form-panel-scheduledtasks':TriSysApex['Pages']['PlacementForm']['LoadScheduledTasksGrid']('placementForm-ScheduledTasksGrid',null);break;case'placement-form-panel-amendments':ctrlPlacementForm['LoadAmendmentsGrid']('placementForm-AmendmentsGrid');break;}},'FileMenuCallback':function(sFileMenuID){var fm=TriSysSDK['FormMenus']['Constants'];switch(sFileMenuID){case fm['File_New']:TriSysApex['Pages']['PlacementForm']['NewRecord']();break;case fm['File_Open']:TriSysApex['Pages']['PlacementForm']['OpenFindDialogue']();break;case fm['File_Save']:TriSysApex['Pages']['PlacementForm']['SaveRecord']();break;case fm['File_Save_As']:TriSysApex['UI']['ShowMessage']('Save\x20Placement\x20As');break;case fm['File_Delete']:TriSysApex['Pages']['PlacementForm']['DeleteRecord']();break;case fm['File_Close']:TriSysApex['FormsManager']['CloseCurrentForm']();break;}},'LineManagerGridFileMenuCallback':function(sFileMenuID){var fm=TriSysSDK['FormMenus']['Constants'],sGrid='placementForm-LineManagerGrid',lContactId=TriSysSDK['Grid']['GetSelectedSingletonRowFieldValueFromGrid'](sGrid,'ContactId','Contact',sFileMenuID!=fm['File_New']);if(lContactId<=0x0&&sFileMenuID!=fm['File_New'])return;switch(sFileMenuID){case fm['File_New']:ctrlPlacementForm['AddCompanyContactToLineManager']();break;case'set-primary':ctrlPlacementForm['AddContactToLineManagerWebAPI'](lContactId,!![]);break;case fm['File_Delete']:var sFullName=TriSysSDK['Grid']['GetSelectedSingletonRowFieldValueFromGrid'](sGrid,'FullName','Contact');ctrlPlacementForm['DeleteLineManager'](lContactId,sFullName);break;}},'TimesheetsGridFileMenuCallback':function(sFileMenuID){var fm=TriSysSDK['FormMenus']['Constants'],sGrid='placementForm-TimesheetGrid',lTimesheetId=TriSysSDK['Grid']['GetSelectedSingletonRowFieldValueFromGrid'](sGrid,'Timesheet_TimesheetId','Timesheet',sFileMenuID!=fm['File_New']);if(lTimesheetId<=0x0&&sFileMenuID!=fm['File_New'])return;switch(sFileMenuID){case fm['File_Open']:TriSysApex['FormsManager']['OpenForm']('Timesheet',lTimesheetId);break;case fm['File_Delete']:TriSysApex['UI']['ShowMessage']('ToDo');break;}},'NotesHistoryGridFileMenuCallback':function(sFileMenuID){ctrlPlacementForm['TaskGridFileMenuCallback'](sFileMenuID,'placementForm-NotesHistoryGrid',![]);},'ScheduledTaskGridFileMenuCallback':function(sFileMenuID){ctrlPlacementForm['TaskGridFileMenuCallback'](sFileMenuID,'placementForm-ScheduledTasksGrid',!![]);},'TaskGridFileMenuCallback':function(sFileMenuID,sGrid,bScheduled){var fm=TriSysSDK['FormMenus']['Constants'],lTaskId=null;switch(sFileMenuID){case fm['File_New']:ctrlPlacementForm['NewTask'](bScheduled);break;case fm['File_Open']:lTaskId=TriSysApex['ModalDialogue']['Task']['GetSelectedSingletonTaskIdFromTaskGrid'](sGrid);if(lTaskId>0x0)TriSysApex['ModalDialogue']['Task']['QuickShow'](lTaskId);break;case fm['File_Delete']:lTaskId=TriSysApex['ModalDialogue']['Task']['GetSelectedSingletonTaskIdFromTaskGrid'](sGrid);if(lTaskId>0x0)TriSysApex['ModalDialogue']['Task']['DeleteTask'](lTaskId);break;}},'NewTask':function(bScheduled){var lPlacementId=TriSysApex['Pages']['PlacementForm']['PlacementId'],lContactId=TriSysApex['Pages']['PlacementForm']['ContactId'],sFullName=$('#Placement_ContactId')['val'](),sCompany=$('#Placement_CompanyId')['val'](),sCandidate=$('#PlacementConfigFields_Candidate')['val'](),sJobTitle=TriSysSDK['CShowForm']['GetJobTitleFromField']('PlacementConfigFields_JobTitle'),sContactType='Client',params=new TriSysApex['ModalDialogue']['Task']['ShowParameters']();params['Scheduled']=bScheduled;var clientContact={'ContactId':lContactId,'FullName':sFullName,'CompanyName':sCompany,'JobTitle':'?','ContactType':sContactType};params['Contacts']['push'](clientContact);var candidateContact={'ContactId':TriSysApex['Pages']['PlacementForm']['CandidateId'],'FullName':sCandidate,'CompanyName':'','JobTitle':sJobTitle,'ContactType':'Candidate'};params['Contacts']['push'](candidateContact);var placementLink={'Name':'Placement','RecordId':lPlacementId,'Description':$('#PlacementConfigFields_Reference')['val']()+':\x20'+TriSysSDK['CShowForm']['GetJobTitleFromField']('PlacementConfigFields_JobTitle')+',\x20'+sCandidate+'\x20at\x20'+sCompany};params['Links']['push'](placementLink),TriSysApex['ModalDialogue']['Task']['Show'](params);},'ActionInvocation':function(sEntityName){switch(sEntityName){case'Placement':var placementIds=[TriSysApex['Pages']['PlacementForm']['PlacementId']];return placementIds;case'Timesheet':var timesheetIds=TriSysSDK['Grid']['GetSelectedMultipleRowsFromGrid']('placementForm-TimesheetGrid','Timesheet_TimesheetId');return timesheetIds;}},'ActionInvocationMasterEntity':function(){var masterEntity={'EntityName':'Placement','EntityId':TriSysApex['Pages']['PlacementForm']['PlacementId']};return masterEntity;},'JobTitleLookup':function(){var sJobTitleField='PlacementConfigFields_JobTitle',sJobTitle=TriSysSDK['CShowForm']['GetJobTitleFromField'](sJobTitleField);TriSysSDK['JobTitle']['Lookup'](sJobTitle,sJobTitleField);},'LoadLineManagers':function(){ctrlPlacementForm['LoadLineManagerGrid'](TriSysApex['Pages']['PlacementForm']['PlacementId'],'placementForm-LineManagerGrid');},'LoadLineManagerGrid':function(lPlacementId,sGridId){var payloadObject={};payloadObject['URL']='Placement/ReadLineManagers';var CPlacementReadLineManagersRequest={'PlacementId':lPlacementId};payloadObject['OutboundDataPacket']=CPlacementReadLineManagersRequest,payloadObject['InboundDataFunction']=function(CPlacementReadLineManagersResponse){if(CPlacementReadLineManagersResponse){if(CPlacementReadLineManagersResponse['Success']){ctrlPlacementForm['DisplayLineManagers'](CPlacementReadLineManagersResponse['LineManagers'],sGridId),ctrlPlacementForm['TimesheetFrequencyEnable'](CPlacementReadLineManagersResponse['TimesheetCount']);return;}else TriSysApex['UI']['ShowMessage'](CPlacementReadLineManagersResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['errorAlert']('ctrlPlacementForm.LoadLineManagerGrid:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'DisplayLineManagers':function(lineManagers,sGridId){var sGridName=sGridId-'-GridInstance',dataSource=[];for(var i=0x0;i<lineManagers['length'];i++){var lineManager=lineManagers[i],contact=lineManager['Contact'];dataSource['push']({'ContactId':contact['ContactId'],'FullName':contact['FullName'],'JobTitle':contact['JobTitle'],'Address':contact['CompanyAddressStreet']+',\x20'+contact['CompanyAddressCity'],'Primary':lineManager['Primary']?'Yes':'No'});}TriSysSDK['Grid']['VirtualMode']({'Div':sGridId,'ID':sGridName,'Title':'Line\x20Managers','RecordsPerPage':TriSysApex['UserOptions']['RecordsPerPage'](),'PopulationByObject':dataSource,'Columns':[{'field':'ContactId','title':'ContactId','type':'number','hidden':!![]},{'field':'FullName','title':'Contact','type':'string'},{'field':'JobTitle','title':'Job\x20Title','type':'string'},{'field':'Address','title':'Work\x20Address','type':'string'},{'field':'Primary','title':'Primary','type':'string'}],'DrillDownFunction':null,'MultiRowSelect':!![],'Grouping':TriSysApex['UserOptions']['GridGrouping']()});},'AddCompanyContactToLineManager':function(){var fnSelectCompanyContact=function(selectedRow){if(!selectedRow)return;var lContactId=selectedRow['ContactId'];if(lContactId>0x0)ctrlPlacementForm['AddContactToLineManagerWebAPI'](lContactId,![]);return!![];},sCompany=$('#Placement_CompanyId')['val']();TriSysApex['ModalDialogue']['CompanyContacts']['Select'](TriSysApex['Pages']['PlacementForm']['CompanyId'],sCompany,null,fnSelectCompanyContact);},'AddContactToLineManagerWebAPI':function(lContactId,bPrimary){var payloadObject={};payloadObject['URL']='Placement/AddLineManager';var lPlacementId=TriSysApex['Pages']['PlacementForm']['PlacementId'],CPlacementAddLineManagerRequest={'PlacementId':lPlacementId,'ContactId':lContactId,'Primary':bPrimary};payloadObject['OutboundDataPacket']=CPlacementAddLineManagerRequest,payloadObject['InboundDataFunction']=function(CPlacementAddLineManagerResponse){if(CPlacementAddLineManagerResponse){if(CPlacementAddLineManagerResponse['Success']){ctrlPlacementForm['LoadLineManagers']();return;}else TriSysApex['UI']['ShowMessage'](CPlacementAddLineManagerResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['errorAlert']('ctrlPlacementForm.AddContactToLineManagerWebAPI:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'DeleteLineManager':function(lContactId,sFullName){var sMessage='Are\x20you\x20sure\x20that\x20you\x20remove\x20'+sFullName+'\x20as\x20a\x20line\x20manager\x20for\x20this\x20placement?';TriSysApex['UI']['questionYesNo'](sMessage,'Remove\x20Line\x20Manager','Yes',function(){return ctrlPlacementForm['DeleteLineManagerFromWebAPI'](lContactId),!![];},'No');},'DeleteLineManagerFromWebAPI':function(lContactId){var payloadObject={};payloadObject['URL']='Placement/DeleteLineManager';var lPlacementId=TriSysApex['Pages']['PlacementForm']['PlacementId'],CPlacementDeleteLineManagerRequest={'PlacementId':lPlacementId,'ContactId':lContactId};payloadObject['OutboundDataPacket']=CPlacementDeleteLineManagerRequest,payloadObject['InboundDataFunction']=function(CPlacementDeleteLineManagerResponse){if(CPlacementDeleteLineManagerResponse){if(CPlacementDeleteLineManagerResponse['Success']){ctrlPlacementForm['LoadLineManagers']();return;}else TriSysApex['UI']['ShowMessage'](CPlacementDeleteLineManagerResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['errorAlert']('ctrlPlacementForm.DeleteLineManagerFromWebAPI:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'CalculateDurationWeeks':function(sFieldID,fValue){var sDurationWeeks='',dtStart=new moment(TriSysSDK['CShowForm']['getDatePickerValue']('PlacementConfigFields_StartDate')),dtEnd=new moment(TriSysSDK['CShowForm']['getDatePickerValue']('PlacementConfigFields_EndDate')),iWeeks=dtEnd['diff'](dtStart,'weeks');if(iWeeks>=0x0)sDurationWeeks=iWeeks;$('#PlacementConfigFields_DurationInWeeks')['val'](sDurationWeeks);},'EditDescription':function(){var txt=$('#PlacementConfigFields_Description'),sDescription=txt['val'](),fnEditedDescription=function(sText){return txt['val'](sText),!![];},options={'Label':'Description','Value':sDescription};TriSysApex['ModalDialogue']['BigEdit']['Popup']('Edit\x20Placement\x20'+options['Label'],'gi-pen',fnEditedDescription,options);},'LoadAmendmentsGrid':function(sGridId){if(TriSysApex['Forms']['EntityForm']['isGridPopulated']('Placement',sGridId))return;var lPlacementId=TriSysApex['Pages']['PlacementForm']['PlacementId'],fnPopulationByFunction={'API':'Amendments/ListForEntityRecord','Parameters':function(request){request['RecordId']=lPlacementId,request['EntityName']='Placement';},'DataTableFunction':function(response){return response['List'];}},columns=[{'field':'ApplicationName','title':'App','type':'string','width':0xa0},{'field':'UpdatedBy','title':'Updated\x20By','type':'string','width':0xdc},{'field':'DateChanged','title':'Updated','type':'date','format':'{0:dd\x20MMM\x20yyyy\x20}','width':0x6e},{'field':'FieldName','title':'Field\x20Name','type':'string','width':0xdc},{'field':'OldValue','title':'Old\x20Value','type':'string'},{'field':'NewValue','title':'New\x20Value','type':'string'}];TriSysSDK['Grid']['VirtualMode']({'Div':sGridId,'ID':sGridId+'-Grid','Title':'Amendments','RecordsPerPage':TriSysApex['UserOptions']['RecordsPerPage'](),'PopulationByFunction':fnPopulationByFunction,'Columns':columns,'MobileVisibleColumns':[{'field':'ApplicationName'}],'MobileRowTemplate':'<td\x20colspan=\x221\x22><strong>#:\x20ApplicationName\x20#</strong><br\x20/>'+'<i>#:\x20UpdatedBy\x20#</i><br\x20/>'+'#:\x20DateChanged\x20#<br\x20/>'+'#:\x20FieldName\x20#<br\x20/>'+'#:\x20OldValue\x20#<br\x20/>'+'#:\x20NewValue\x20#'+'</td>','MultiRowSelect':![],'Grouping':![],'ColumnFilters':!![]});},'ReAssignUser':function(){var sUser=TriSysSDK['CShowForm']['GetTextFromCombo']('Placement_UserId'),userCredentials=TriSysApex['LoginCredentials']['UserCredentials'](),sLoggedInUserFullName=userCredentials['LoggedInUser']['Contact']['FullName'],bAllowOwnershipChange=TriSysAPI['Operators']['stringToBoolean'](TriSysApex['Cache']['SystemSettingManager']['GetValue']('Placement:\x20Allow\x20Ownership\x20Change',![])),bCanChangeOwnership=sUser==sLoggedInUserFullName||bAllowOwnershipChange;if(!bCanChangeOwnership){TriSysApex['UI']['ShowMessage']('You\x20are\x20not\x20the\x20owner\x20of\x20this\x20placement\x20so\x20cannot\x20change\x20the\x20user.');return;}var fnSelectUser=function(selectedRow){if(!selectedRow)return![];var lUserId=selectedRow['UserId'],sFullName=selectedRow['FullName'];if(lUserId<=0x0)return![];return setTimeout(function(){ctrlPlacementForm['ReAssignUserViaWebService'](lUserId,sFullName);},0x32),!![];};TriSysApex['ModalDialogue']['Users']['Select'](fnSelectUser,{'Title':'Select\x20the\x20new\x20Placement\x20Owner','NotLocked':!![]});},'ReAssignUserViaWebService':function(lUserId,sFullName){var payloadObject={};payloadObject['URL']='Placement/ReAssignUser',payloadObject['OutboundDataPacket']={'PlacementId':TriSysApex['Pages']['PlacementForm']['PlacementId'],'UserId':lUserId},payloadObject['InboundDataFunction']=function(CReAssignPlacementUserResponse){TriSysApex['UI']['HideWait']();if(CReAssignPlacementUserResponse)CReAssignPlacementUserResponse['Success']?(TriSysSDK['CShowForm']['SetTextInCombo']('Placement_UserId',sFullName),TriSysApex['Pages']['PlacementForm']['UserId']=lUserId):TriSysApex['UI']['errorAlert'](CReAssignRequirementUserResponse['ErrorMessage']);else{}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['HideWait'](),TriSysApex['UI']['ErrorHandlerRedirector']('ctrlPlacementForm.ReAssignUserViaWebService:\x20',request,status,error);},TriSysApex['UI']['ShowWait'](null,'Updating...'),TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'TimesheetFrequencyEnable':function(lTimesheetCount){var bReadOnly=lTimesheetCount>0x0;TriSysSDK['CShowForm']['ComboReadonly']('PlacementConfigFields_TimesheetFrequency',bReadOnly);}};$(document)['ready'](function(){ctrlPlacementForm['Load']();});