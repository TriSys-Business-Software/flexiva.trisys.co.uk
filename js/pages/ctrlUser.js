var ctrlUser={'ContactId':0x0,'CompanyId':0x0,'Load':function(){$('#user-form-loginname')['focus']();if(AdminConsole['EditUserId']==0x0&&AdminConsole['CloneFromUserId']==0x0)return;ctrlUser['ContactId']=0x0,ctrlUser['CompanyId']=0x0;var bChangeEMailOnNameEdit=!![];if(AdminConsole['EditUserId']>0x0)ctrlUser['ReadUserFromWebAPI'](AdminConsole['EditUserId']),bChangeEMailOnNameEdit=![];else{$('#user-form-userid-tr')['hide'](),$('#user-form-contact-tr')['hide'](),$('#user-form-loggedin-locked-tr')['hide'](),$('#user-form-last-login-tr')['hide'](),$('#user-form-add-account-help-tr')['show'](),$('#user-form-loginname')['attr']('readonly','readonly'),$('#user-form-email')['attr']('readonly',![]);var userCredentials=TriSysApex['LoginCredentials']['UserCredentials'](),sCurrentEMail=userCredentials['LoggedInUser']['FullName'],parts=sCurrentEMail['split']('@'),sDomain='@'+parts[0x1];$('#user-form-email')['val'](sDomain),$('#user-form-telno')['val'](userCredentials['LoggedInUser']['Contact']['WorkTelNo']);var sPassword=ctrlUser['RandomPassword']();$('#user-form-password')['val'](sPassword),$('#user-form-password-confirmation')['val'](sPassword);}$('#user-form-name')['keyup'](function(event){var sName=$(this)['val']();if(sName){var sLoginName=ctrlUser['RemoveInvalidCharactersFromLoginName'](sName);$('#user-form-loginname')['val'](sLoginName);if(bChangeEMailOnNameEdit)$('#user-form-email')['val'](sLoginName+sDomain);}}),$('#user-form-name')['focus']();},'RemoveInvalidCharactersFromLoginName':function(sLoginName){return sLoginName=sLoginName['toLowerCase']()['replace'](/ /g,'.'),sLoginName=sLoginName['toLowerCase']()['replace'](/\'/g,''),sLoginName=sLoginName['toLowerCase']()['replace'](/"/g,''),sLoginName;},'RandomPassword':function(){var sPassword=TriSysSDK['Miscellaneous']['GUID']()['replace'](/-/g,'');return sPassword=sPassword['substring'](0x0,TriSysApex['Constants']['iMinimumPasswordLength']+0x1),sPassword;},'ReadUserFromWebAPI':function(lUserId){var CReadUserAccountRequest={'UserId':lUserId},payloadObject={};payloadObject['URL']='Users/ReadUserAccount',payloadObject['OutboundDataPacket']=CReadUserAccountRequest,payloadObject['InboundDataFunction']=function(CReadUserAccountResponse){TriSysApex['UI']['HideWait']();if(CReadUserAccountResponse){if(CReadUserAccountResponse['Success']){var CReadUserAccount=CReadUserAccountResponse['UserAccount'];$('#user-form-userid')['val'](CReadUserAccount['UserId']),$('#user-form-loginname')['val'](CReadUserAccount['LoginName']),$('#user-form-password')['val'](CReadUserAccount['Password']),$('#user-form-name')['val'](CReadUserAccount['FullName']),$('#user-form-telno')['val'](CReadUserAccount['TelNo']),TriSysSDK['CShowForm']['SetCheckBoxValue']('user-form-loggedin',CReadUserAccount['LoggedIn']),TriSysSDK['CShowForm']['SetCheckBoxValue']('user-form-locked',CReadUserAccount['Locked']);var sLastLogin='';if(CReadUserAccount['LastLoginDate']){if(moment(CReadUserAccount['LastLoginDate'])['year']()>0x1)sLastLogin=moment(CReadUserAccount['LastLoginDate'])['format']('dddd\x20DD\x20MMMM\x20YYYY');}$('#user-form-last-login')['html'](sLastLogin);CReadUserAccount['Photo']&&($('#user-form-photo')['attr']('src',CReadUserAccount['Photo']),$('#user-form-photo')['show']());if(CReadUserAccount['Contact']){var contact=CReadUserAccount['Contact'];ctrlUser['ContactId']=contact['ContactId'],ctrlUser['CompanyId']=contact['CompanyId'];var sContactSummary=contact['FullName']+'\x0a'+contact['CompanyName']+(contact['CompanyAddressStreet']?'\x0a'+contact['CompanyAddressStreet']:'')+(contact['CompanyAddressCity']?'\x0a'+contact['CompanyAddressCity']:'')+(contact['WorkTelNo']?'\x0a'+contact['WorkTelNo']:'');$('#user-form-contact')['val'](sContactSummary),$('#user-form-email')['val'](contact['WorkEMail']);}}else TriSysApex['UI']['ShowMessage'](CReadUserAccountResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['HideWait'](),TriSysApex['UI']['errorAlert']('ctrlUser.Load:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysApex['UI']['ShowWait'](null,'Reading\x20User...'),TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'ViewContactRecord':function(){ctrlUser['ContactId']>0x0&&(TriSysApex['FormsManager']['OpenForm']('Contact',ctrlUser['ContactId']),TriSysApex['UI']['CloseModalPopup']());},'ViewCompanyRecord':function(){ctrlUser['CompanyId']>0x0&&(TriSysApex['FormsManager']['OpenForm']('Company',ctrlUser['CompanyId']),TriSysApex['UI']['CloseModalPopup']());},'ValidateDataEntry':function(){var bCloneUser=AdminConsole['CloneFromUserId']>0x0,CWriteUserAccount={};CWriteUserAccount['UserId']=AdminConsole['EditUserId'],CWriteUserAccount['CloneUserId']=AdminConsole['CloneFromUserId'],CWriteUserAccount['LoginName']=$('#user-form-loginname')['val'](),CWriteUserAccount['Password']=$('#user-form-password')['val'](),CWriteUserAccount['FullName']=$('#user-form-name')['val'](),CWriteUserAccount['TelNo']=$('#user-form-telno')['val'](),CWriteUserAccount['EMail']=$('#user-form-email')['val'](),CWriteUserAccount['LoggedIn']=TriSysSDK['CShowForm']['CheckBoxValue']('user-form-loggedin'),CWriteUserAccount['Locked']=TriSysSDK['CShowForm']['CheckBoxValue']('user-form-locked');if(!CWriteUserAccount['LoginName']||!CWriteUserAccount['FullName'])return TriSysApex['UI']['ShowMessage']('Please\x20enter\x20a\x20login\x20name\x20and\x20full\x20name.'),null;var sError=TriSysApex['LoginCredentials']['ValidatePassword'](CWriteUserAccount['Password']);sError&&(CWriteUserAccount['Password']=ctrlUser['RandomPassword']());var bSpaceFound=CWriteUserAccount['FullName']['indexOf']('\x20')>0x0;if(!bSpaceFound)return TriSysApex['UI']['ShowMessage']('Please\x20enter\x20a\x20full\x20name\x20containing\x20at\x20least\x20a\x20forename\x20and\x20surname.'),null;if(bCloneUser){var sPasswordConfirmation=$('#user-form-password-confirmation')['val']();if(CWriteUserAccount['Password']!=sPasswordConfirmation)return TriSysApex['UI']['ShowMessage']('Password\x20and\x20confirmation\x20do\x20not\x20match.'),null;if(!TriSysApex['LoginCredentials']['validateEmail'](CWriteUserAccount['EMail']))return TriSysApex['UI']['ShowMessage']('Please\x20enter\x20a\x20valid\x20e-mail\x20address.'),null;}return CWriteUserAccount;},'SaveButtonClick':function(lCRMContactId){var CWriteUserAccount=ctrlUser['ValidateDataEntry']();if(!CWriteUserAccount)return;CWriteUserAccount['CRMContactId']=lCRMContactId;var bCloneUser=AdminConsole['CloneFromUserId']>0x0;if(bCloneUser){var fnSaveUser=function(){setTimeout(function(){ctrlUser['SubmitSaveToWebAPI'](CWriteUserAccount);},0x32);};fnSaveUser();return;ctrlUser['PromptForConfirmationOfNewUserAccount'](function(){return fnSaveUser(),!![];});}else ctrlUser['SubmitSaveToWebAPI'](CWriteUserAccount);},'SendActivationCodeForExistingUserAccount':function(){var CWriteUserAccount=ctrlUser['ValidateDataEntry']();if(!CWriteUserAccount)return;var fnCallback=function(lUserId){var CSendActivationCode={'UserId':lUserId},payloadObject={};payloadObject['URL']='Users/SendActivationCode',payloadObject['OutboundDataPacket']=CSendActivationCode,payloadObject['InboundDataFunction']=function(CSendActivationCodeResponse){TriSysApex['UI']['HideWait']();if(CSendActivationCodeResponse){if(CSendActivationCodeResponse['Success']){AdminConsole['PostSaveUserAccountEvent'](null,lUserId);return;}else TriSysApex['UI']['ShowMessage'](CSendActivationCodeResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['HideWait'](),TriSysApex['UI']['errorAlert']('ctrlUser.SendActivationCodeForExistingUserAccount:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysApex['UI']['ShowWait'](null,'Sending\x20Activation\x20Code...'),TriSysAPI['Data']['PostToWebAPI'](payloadObject);};ctrlUser['SubmitSaveToWebAPI'](CWriteUserAccount,fnCallback);},'PromptForConfirmationOfNewUserAccount':function(fnCallbackOnAgree){var parametersObject=new TriSysApex['UI']['ShowMessageParameters']();parametersObject['Title']=TriSysApex['Copyright']['ShortProductName']+'\x20New\x20Account\x20Terms\x20&amp;\x20Conditions',parametersObject['Image']='gi-more_items',parametersObject['Maximize']=!![],parametersObject['ContentURL']=TriSysApex['Constants']['UserControlFolder']+'ctrlAddUserTermsAndConditions.html',parametersObject['ButtonLeftText']='I\x20Agree',parametersObject['ButtonLeftVisible']=!![],parametersObject['ButtonLeftFunction']=fnCallbackOnAgree,parametersObject['ButtonCentreText']='View\x20Full\x20Terms\x20&amp;\x20Conditions',parametersObject['ButtonCentreVisible']=!![],parametersObject['ButtonCentreFunction']=function(){return setTimeout(TriSysApex['ModalDialogue']['TermsAndConditions']['Show'],0x32),!![];},parametersObject['ButtonRightText']='Cancel',parametersObject['ButtonRightVisible']=!![],TriSysApex['UI']['PopupMessage'](parametersObject);},'SubmitSaveToWebAPI':function(CWriteUserAccount,fnCallback){var payloadObject={};payloadObject['URL']='Users/WriteUserAccount',payloadObject['OutboundDataPacket']=CWriteUserAccount,payloadObject['InboundDataFunction']=function(CWriteUserAccountResponse){TriSysApex['UI']['HideWait']();if(CWriteUserAccountResponse){if(CWriteUserAccountResponse['Success']){TriSysApex['Cache']['cachedStandingDataInMemory']['Users']=CWriteUserAccountResponse['Users'];if(fnCallback)fnCallback(CWriteUserAccountResponse['UserId']);else AdminConsole['PostSaveUserAccountEvent'](CWriteUserAccountResponse);return;}else TriSysApex['UI']['ShowMessage'](CWriteUserAccountResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['HideWait'](),TriSysApex['UI']['errorAlert']('ctrlUser.Save:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysApex['UI']['ShowWait'](null,'Saving\x20User...'),TriSysAPI['Data']['PostToWebAPI'](payloadObject);}};$(document)['ready'](function(){ctrlUser['Load']();});