var ctrlCompanyOrganogram={'DivTag':null,'PostLoad':function(lCompanyId,parentDiv){ctrlCompanyOrganogram['RetainedContactHierarchy']=null,ctrlCompanyOrganogram['DivTag']=parentDiv,TriSysApex['ControlPopulationDirty']['ClearPopulationAndDirtyStatus'](ctrlCompanyOrganogram['DivTag']);if(lCompanyId>0x0)ctrlCompanyOrganogram['ReadFromWebAPI'](lCompanyId);setTimeout(TriSysProUI['kendoUI_Overrides'],0x64);return;var lCompanyId=TriSysApex['Pages']['CompanyForm']['CompanyId'],company={'CompanyId':lCompanyId,'Name':'Althorp','Industry':'Stately\x20Home','TelNo':'01278\x20827\x20872','WebSite':'www.althorp-estate.uk.org'},hierarchy=ctrlCompanyOrganogram['FakePopulationFromWebAPI']();ctrlCompanyOrganogram['PopulateDOM'](company,hierarchy),ctrlCompanyOrganogram['InvokeOrganogramRocketScience']();},'FakePopulationFromWebAPI':function(){var hierarchy=[],Tony={'ContactId':0x1,'FullName':'Tony\x20Mandridge','Image':'http://www.trisys.co.uk/img/staffpictures/gl.png','JobTitle':'Founder\x20&amp;\x20CEO','City':'Cambridge','EMail':'tony@althorp.com','TelNo':'01223\x20564\x204567','ParentContactId':0x0};hierarchy['push'](Tony);var Jodie={'ContactId':0x2,'FullName':'Jodie\x20Marsh','Image':'http://www.trisys.co.uk/img/staffpictures/jp.png','JobTitle':'Business\x20Analyst','EMail':'jodie@althorp.com','TelNo':'01223\x20564\x204567','ParentContactId':0x1};hierarchy['push'](Jodie);var Pingu={'ContactId':0x3,'FullName':'Pingu\x20Gringo','Image':'http://www.trisys.co.uk/img/staffpictures/pe.png','JobTitle':'IT\x20Manager','City':'Cambridge','EMail':'pingu@althorp.com','TelNo':'01223\x20564\x204567','ParentContactId':0x1};hierarchy['push'](Pingu);var Jimmy={'ContactId':0x4,'FullName':'Jimmy\x20Dean','Image':'http://www.trisys.co.uk/img/staffpictures/ja.png','JobTitle':'Developer','City':'Cambridge','EMail':'jimmmy@althorp.com','TelNo':'01223\x20564\x204567','ParentContactId':0x3};return hierarchy['push'](Jimmy),hierarchy;},'ReadFromWebAPI':function(lCompanyId){var CCompanyReadOrganogramRequest={'CompanyId':lCompanyId},payloadObject={};payloadObject['URL']='Company/ReadOrganogram',payloadObject['OutboundDataPacket']=CCompanyReadOrganogramRequest,payloadObject['InboundDataFunction']=function(data){TriSysApex['UI']['HideWait']();var CCompanyReadOrganogramResponse=data;if(CCompanyReadOrganogramResponse){if(CCompanyReadOrganogramResponse['Success']){ctrlCompanyOrganogram['PopulateAndDrawOrganogram'](CCompanyReadOrganogramResponse),TriSysApex['ControlPopulationDirty']['SetPopulated'](ctrlCompanyOrganogram['DivTag'],!![]);return;}else TriSysApex['UI']['ShowMessage'](CCompanyReadOrganogramResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['HideWait'](),TriSysApex['UI']['errorAlert']('ctrlCompanyOrganogram.ReadFromWebAPI:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysApex['UI']['ShowWait'](null,'Reading\x20Company\x20Hierarchy...'),TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'PopulateAndDrawOrganogram':function(CCompanyReadOrganogramResponse){var company={'CompanyId':CCompanyReadOrganogramResponse['CompanyId'],'Name':CCompanyReadOrganogramResponse['Name'],'Industry':CCompanyReadOrganogramResponse['Industry'],'TelNo':CCompanyReadOrganogramResponse['TelNo'],'WebSite':CCompanyReadOrganogramResponse['WebSite'],'Image':CCompanyReadOrganogramResponse['Image']},hierarchy=[];if(CCompanyReadOrganogramResponse['Contacts'])for(var i=0x0;i<CCompanyReadOrganogramResponse['Contacts']['length'];i++){var contact=CCompanyReadOrganogramResponse['Contacts'][i];hierarchy['push'](contact);}ctrlCompanyOrganogram['RetainedContactHierarchy']=hierarchy,ctrlCompanyOrganogram['PopulateCompanyInDOM'](company),ctrlCompanyOrganogram['PopulateContactsDOM'](hierarchy),ctrlCompanyOrganogram['InvokeOrganogramRocketScience']();},'RetainedContactHierarchy':null,'PopulateCompanyInDOM':function(company){var sRootFile=TriSysApex['Constants']['UserControlFolder']+'ctrlCompanyOrganogramRoot.html',sRootTemplate=TriSysApex['NavigationBar']['TemplateFile'](sRootFile),sImage=company['Image'];if(!sImage)sImage=TriSysApex['Constants']['DefaultCompanyImage'];sRootTemplate=sRootTemplate['replace']('##company-photo##',sImage),sRootTemplate=sRootTemplate['replace'](/##company-id##/g,company['CompanyId']),sRootTemplate=sRootTemplate['replace'](/##company-name##/g,company['Name']),sRootTemplate=sRootTemplate['replace'](/##company-industry##/g,company['Industry']),sRootTemplate=sRootTemplate['replace'](/##company-telno##/g,company['TelNo']),sRootTemplate=sRootTemplate['replace'](/##company-website##/g,company['WebSite']),$('#trisys-organogram-hierarchy')['append'](sRootTemplate);},'PopulateContactsDOM':function(hierarchy){$('#trisys-org-contact-list')['empty']();try{var sFile=TriSysApex['Constants']['UserControlFolder']+'ctrlCompanyOrganogramNode.html',sNodeTemplate=TriSysApex['NavigationBar']['TemplateFile'](sFile);for(var iTopNode=0x0;iTopNode<hierarchy['length'];iTopNode++){var contact=hierarchy[iTopNode];contact['Drawn']=![];if(contact['ParentContactId']==0x0){var sNode=ctrlCompanyOrganogram['CreateContactNodeLI'](contact,sNodeTemplate);$('#trisys-org-contact-list')['append'](sNode),contact['Drawn']=!![];}}var moreNodesToBeDrawn=!![],iMaxIterations=0x20,iIterationCounter=0x0;while(moreNodesToBeDrawn&&iIterationCounter<iMaxIterations){iIterationCounter+=0x1;for(var iNode=0x0;iNode<hierarchy['length'];iNode++){var contact=hierarchy[iNode];if(!contact['Drawn']&&contact['ParentContactId']>0x0){var sNode=ctrlCompanyOrganogram['CreateContactNodeLI'](contact,sNodeTemplate),parentUL=$('#trisys-org-contact-staff-of-'+contact['ParentContactId']);parentUL['length']>0x0&&(parentUL['append'](sNode),contact['Drawn']=!![]);}}moreNodesToBeDrawn=![];for(var iNode=0x0;iNode<hierarchy['length'];iNode++){var contact=hierarchy[iNode];if(!contact['Drawn'])moreNodesToBeDrawn=!![];}}}catch(e){TriSysApex['Logging']['LogMessage'](e['message']);}return;var lContactId=0x181cd;sNode=sNode['replace']('##contact-photo##','http://www.trisys.co.uk/img/staffpictures/ja.png'),sNode=sNode['replace'](/##contact-id##/g,lContactId),sNode=sNode['replace']('##contact-name##','jimmy\x20Dean'),sNode=sNode['replace']('##contact-jobtitle##','Propeller\x20Head'),sNode=sNode['replace']('##contact-city##','Aberdeen'),sNode=sNode['replace']('##contact-email##','skenken@althorp.com'),sNode=sNode['replace']('##contact-telno##','01234\x20567\x20890'),sNode='<li\x20id=\x22trisys-org-contactid-'+lContactId+'\x22\x20>'+sNode+'</li>',$('#trisys-org-contact-list')['prepend'](sNode);},'CreateContactNodeLI':function(contact,sNode){var sLI='<li\x20id=\x22trisys-org-contactid-'+contact['ContactId']+'\x22>',sImage=contact['Image'];if(!sImage)sImage=TriSysApex['Constants']['DefaultContactImage'];sNode=sNode['replace']('##contact-photo##',sImage),sNode=sNode['replace'](/##contact-id##/g,contact['ContactId']),sNode=sNode['replace']('##contact-name##',contact['FullName']),sNode=sNode['replace']('##contact-jobtitle##',contact['JobTitle']),sNode=sNode['replace']('##contact-city##',contact['City']),sNode=sNode['replace']('##contact-email##',contact['EMail']),sNode=sNode['replace']('##contact-telno##',contact['TelNo']);var sPlaceholder='<ul\x20id=\x22trisys-org-contact-staff-of-'+contact['ContactId']+'\x22></ul>';return sLI+sNode+sPlaceholder+'</li>';},'InvokeOrganogramRocketScience':function(){try{$('#trisys-organogram-rendered-chart')['empty'](),$('#trisys-organogram-hierarchy')['jOrgChart']({'chartElement':'#trisys-organogram-rendered-chart','dragAndDrop':!![]}),TriSysSDK['CompanyOrganogram']['ApplyCSSColours']();}catch(err){TriSysApex['UI']['ShowError'](err);}},'AfterNodeRelocation':function(sDOM_HTML){TriSysApex['ControlPopulationDirty']['SetDirty'](ctrlCompanyOrganogram['DivTag'],!![]);var domHierarchy=[],lCompanyId=TriSysApex['Pages']['CompanyForm']['CompanyId'],companyLI=$('#trisys-org-companyid-'+lCompanyId);ctrlCompanyOrganogram['RecursiveHierarchyEnumeration'](companyLI,0x0,domHierarchy);var hierarchy=ctrlCompanyOrganogram['RetainedContactHierarchy'],iRemoveIndex=-0x1;for(var i=0x0;i<hierarchy['length'];i++){var contact=hierarchy[i];for(var j=0x0;j<domHierarchy['length'];j++){var contact2=domHierarchy[j];if(contact2['ContactId']==contact['ContactId'])contact['ParentContactId']=contact2['ParentContactId'];}}},'RecursiveHierarchyEnumeration':function(li,lParentContactId,domHierarchy){var ul=li['find']('ul');ul&&ul['each'](function(){var ulInstance=$(this),liList=ulInstance['find']('li');liList['each'](function(){var liInstance=$(this),sContactID=liInstance['attr']('id');if(sContactID){var lContactId=ctrlCompanyOrganogram['ParseContactIdFromNodeId'](sContactID);ctrlCompanyOrganogram['AddContactToHierarchyArray'](lContactId,lParentContactId,domHierarchy),ctrlCompanyOrganogram['RecursiveHierarchyEnumeration'](liInstance,lContactId,domHierarchy);}});});},'AddContactToHierarchyArray':function(lContactId,lParentContactId,domHierarchy){var bFound=![];for(var i=0x0;i<domHierarchy['length'];i++){var item=domHierarchy[i];if(item['ContactId']==lContactId){bFound=!![];break;}}if(!bFound){var contact={'ContactId':lContactId,'ParentContactId':lParentContactId};domHierarchy['push'](contact);}},'ParseContactIdFromNodeId':function(sLIid){var parts=sLIid['split']('-contactid-');return parts[0x1];},'DeleteContact':function(lContactId){var hierarchy=ctrlCompanyOrganogram['RetainedContactHierarchy'],iRemoveIndex=-0x1;for(var i=0x0;i<hierarchy['length'];i++){var contact=hierarchy[i];if(contact['ContactId']==lContactId){iRemoveIndex=i;for(var j=0x0;j<hierarchy['length'];j++){var contact2=hierarchy[j];if(contact2['ParentContactId']==contact['ContactId'])contact2['ParentContactId']=contact['ParentContactId'];}}}iRemoveIndex>=0x0&&(TriSysApex['ControlPopulationDirty']['SetDirty'](ctrlCompanyOrganogram['DivTag'],!![]),hierarchy['splice'](iRemoveIndex,0x1),ctrlCompanyOrganogram['PopulateContactsDOM'](hierarchy),ctrlCompanyOrganogram['InvokeOrganogramRocketScience']());},'FileMenuItemSelectionCallback':function(sFileMenuID){switch(sFileMenuID){case'company-organogram-file-menu-add-existing':ctrlCompanyOrganogram['SelectCompanyContact']();break;case'company-organogram-file-menu-add-all':ctrlCompanyOrganogram['SelectAllCompanyContactsNotInOrganogram']();break;case'company-organogram-file-menu-clear-all':ctrlCompanyOrganogram['ClearAllContacts']();break;}},'SelectCompanyContact':function(){var fnSelectCompanyContact=function(selectedRow){if(!selectedRow)return;var lContactId=selectedRow['ContactId'];return lContactId&&ctrlCompanyOrganogram['SelectAllCompanyContactsNotInOrganogram'](lContactId),!![];},lCompanyId=TriSysApex['Pages']['CompanyForm']['CompanyId'],sCompany=$('#Company_Name')['val']();TriSysApex['ModalDialogue']['CompanyContacts']['Select'](lCompanyId,sCompany,0x0,fnSelectCompanyContact);},'AddUserSelectedContact':function(contact){var hierarchy=ctrlCompanyOrganogram['RetainedContactHierarchy'];if(hierarchy){var lstContacts=[];for(var i=0x0;i<hierarchy['length'];i++){var existingContact=hierarchy[i];if(contact['ContactId']==existingContact['ContactId']){setTimeout(function(){TriSysApex['UI']['ShowMessage']('Contact:\x20'+contact['FullName']+'\x20is\x20already\x20shown.');},0x64);return;}}}TriSysApex['ControlPopulationDirty']['SetDirty'](ctrlCompanyOrganogram['DivTag'],!![]);var hierarchy=ctrlCompanyOrganogram['RetainedContactHierarchy'];hierarchy['unshift'](contact),ctrlCompanyOrganogram['PopulateContactsDOM'](hierarchy),ctrlCompanyOrganogram['InvokeOrganogramRocketScience']();},'SelectAllCompanyContactsNotInOrganogram':function(lContactIdOnly){var hierarchy=ctrlCompanyOrganogram['RetainedContactHierarchy'];if(!hierarchy)return;var lstContacts=[];for(var i=0x0;i<hierarchy['length'];i++){var contact=hierarchy[i];lstContacts['push'](contact['ContactId']);}var lCompanyId=TriSysApex['Pages']['CompanyForm']['CompanyId'],CCompanyReadNonOrganogrammedContactsRequest={'CompanyId':lCompanyId,'Contacts':lstContacts},payloadObject={};payloadObject['URL']='Company/ReadNonOrganogrammedContacts',payloadObject['OutboundDataPacket']=CCompanyReadNonOrganogrammedContactsRequest,payloadObject['InboundDataFunction']=function(data){TriSysApex['UI']['HideWait']();var CCompanyReadNonOrganogrammedContactsResponse=data;if(CCompanyReadNonOrganogrammedContactsResponse){if(CCompanyReadNonOrganogrammedContactsResponse['Success']){if(CCompanyReadNonOrganogrammedContactsResponse['Contacts']&&CCompanyReadNonOrganogrammedContactsResponse['Contacts']['length']>0x0){TriSysApex['ControlPopulationDirty']['SetDirty'](ctrlCompanyOrganogram['DivTag'],!![]);var hierarchy=ctrlCompanyOrganogram['RetainedContactHierarchy'];for(var i=0x0;i<CCompanyReadNonOrganogrammedContactsResponse['Contacts']['length'];i++){var contact=CCompanyReadNonOrganogrammedContactsResponse['Contacts'][i],bAddToArray=!![];if(lContactIdOnly){if(contact['ContactId']!=lContactIdOnly)bAddToArray=![];}if(bAddToArray)hierarchy['unshift'](contact);}ctrlCompanyOrganogram['PopulateContactsDOM'](hierarchy),ctrlCompanyOrganogram['InvokeOrganogramRocketScience']();}return;}else TriSysApex['UI']['ShowMessage'](CCompanyReadNonOrganogrammedContactsResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['HideWait'](),TriSysApex['UI']['errorAlert']('ctrlCompanyOrganogram.SelectAllCompanyContactsNotInOrganogram:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysApex['UI']['ShowWait'](null,'Reading\x20Company\x20Contacts...'),TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'ClearAllContacts':function(){ctrlCompanyOrganogram['RetainedContactHierarchy']=[];var hierarchy=ctrlCompanyOrganogram['RetainedContactHierarchy'];ctrlCompanyOrganogram['PopulateContactsDOM'](hierarchy),ctrlCompanyOrganogram['InvokeOrganogramRocketScience']();},'Save':function(lCompanyId){var hierarchy=ctrlCompanyOrganogram['RetainedContactHierarchy'];if(!hierarchy)return;var lstContacts=[];for(var i=0x0;i<hierarchy['length'];i++){var contact=hierarchy[i],sparseContact={'ContactId':contact['ContactId'],'ParentContactId':contact['ParentContactId']};lstContacts['push'](sparseContact);}var CCompanyWriteOrganogramRequest={'CompanyId':lCompanyId,'Contacts':lstContacts},payloadObject={};payloadObject['URL']='Company/WriteOrganogram',payloadObject['OutboundDataPacket']=CCompanyWriteOrganogramRequest,payloadObject['InboundDataFunction']=function(data){var CCompanyWriteOrganogramResponse=data;if(CCompanyWriteOrganogramResponse){if(CCompanyWriteOrganogramResponse['Success']){TriSysApex['ControlPopulationDirty']['SetDirty'](ctrlCompanyOrganogram['DivTag'],![]);return;}else TriSysApex['UI']['ShowMessage'](CCompanyWriteOrganogramResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['HideWait'](),TriSysApex['UI']['errorAlert']('ctrlCompanyOrganogram.Save:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysAPI['Data']['PostToWebAPI'](payloadObject);}};