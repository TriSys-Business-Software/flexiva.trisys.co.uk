class CTriSysSocketIO{constructor(sAPIKey,sDataServicesKey){this['ServerURL']='https://node.trisys.co.uk',this['m_Socket']=null,this['RoomMessageType']='room\x20message',this['ConnectedCallback']=null,this['ReceivedMessageCallback']=null,this['MessageSentCallback']=null,this['MessageSendErrorCallback']=null,this['APIKey']=sAPIKey,this['DataServicesKey']=sDataServicesKey,this['_SenderSubscriberID']=null,this['_LastMessageReceived']=null,this['_KeepAliveTimeWindowSeconds']=0x3c,this['_KeepAlivesEnabled']=![],this['_JoinedRoom']=![];}['Connect'](sSenderSubscriberID,fnCallback){this['_SenderSubscriberID']=sSenderSubscriberID;if(!this['m_Socket']){var self=this,securityOptions={'query':{'SiteKey':this['APIKey'],'DataServicesKey':this['DataServicesKey'],'ID':sSenderSubscriberID}};this['m_Socket']=io(this['ServerURL'],securityOptions),this['m_Socket']['on']('connect',()=>{if(self['ConnectedCallback'])self['ConnectedCallback']('Connected\x20to\x20Socket.IO\x20server:\x20'+self['ServerURL']);!self['_JoinedRoom']&&self['JoinRoom'](sSenderSubscriberID,self['m_Socket']);self['_LastMessageReceived']=new Date();if(fnCallback)fnCallback('Connected\x20to\x20'+self['ServerURL'],![]);}),this['m_Socket']['on'](this['RoomMessageType'],message=>{self['_LastMessageReceived']=new Date();if(self['ReceivedMessageCallback'])self['ReceivedMessageCallback'](message);}),setTimeout(this['KeepAliveCheckingAlgorithm'],this['_KeepAliveTimeWindowSeconds']*0x3e8);}}['JoinRoom'](roomId,socket,callback){var apiURL=this['ServerURL']+'/rooms/join',data=JSON['stringify']({'roomId':roomId,'socketId':socket['id']}),xhr=new XMLHttpRequest();xhr['open']('POST',apiURL,!![]),xhr['setRequestHeader']('Content-Type','application/json'),xhr['onreadystatechange']=function(){if(xhr['readyState']===0x4){if(xhr['status']===0xc8){var result=JSON['parse'](xhr['responseText']);console['log']('Join\x20room\x20response:',result);if(callback)callback(null,result);}else{console['error']('Failed\x20to\x20join\x20room:',xhr['statusText']);if(callback)callback(new Error('Failed\x20to\x20join\x20room:\x20'+xhr['statusText']));}}},xhr['onerror']=function(){console['error']('Error\x20in\x20network\x20request:',xhr['statusText']);if(callback)callback(new Error('Network\x20Error:\x20'+xhr['statusText']));},xhr['send'](data);}['Disconnect'](){if(this['m_Socket'])this['m_Socket']['disconnect']();return;var apiURL=this['ServerURL']+'/rooms/leave',self=this,data={'roomId':this['_SenderSubscriberID'],'socketId':this['m_Socket']['id']};fetch(apiURL,{'method':'POST','headers':{'Content-Type':'application/json'},'body':JSON['stringify'](data)})['then'](response=>{if(!response['ok'])throw new Error('Server\x20responded\x20with\x20a\x20status:\x20'+response['status']);return self['m_Socket']['disconnect'](),response['json']();})['then'](data=>console['log'](data))['catch'](error=>console['error']('Error:',error));return;}['RefreshConnection'](){if(!this['_KeepAlivesEnabled'])return;var self=this;return this['Disconnect']()['then'](function(){self['m_Socket']=null,self['Connect'](self['_SenderSubscriberID']);})['catch'](function(error){console['error']('Error\x20during\x20refresh\x20connection:',error);throw error;});}['ReconnectedToWebAPI'](){var self=this;return this['RefreshConnection']()['then'](function(){console['log']('Reconnected\x20and\x20refreshed\x20successfully.');})['catch'](function(error){console['error']('Error\x20during\x20reconnection\x20and\x20refresh:',error);throw error;});}['KeepAlive'](keepAliveMessage){this['_KeepAliveTimeWindowSeconds']=keepAliveMessage['TimeWindowSeconds'];}['KeepAliveCheckingAlgorithm'](bSelfSentRequest){if(!this['_KeepAlivesEnabled'])return;var bRefreshConnection=![];if(this['_LastMessageReceived']){var dtNow=new Date(),fnGetDifferenceInSeconds=function(dt1,dt2){let differenceInMilliseconds=dt2-dt1;return differenceInMilliseconds/0x3e8;},iSeconds=fnGetDifferenceInSeconds(this['_LastMessageReceived'],dtNow);bRefreshConnection=iSeconds>this['_KeepAliveTimeWindowSeconds'];}if(bRefreshConnection){if(bSelfSentRequest)this['RefreshConnection']();else{var fnOnResponse=function(){setTimeout(function(){this['KeepAliveCheckingAlgorithm'](!![]);},0x3e8);};this['EchoTest'](fnOnResponse);}}else setTimeout(this['KeepAliveCheckingAlgorithm'],this['_KeepAliveTimeWindowSeconds']*0x3e8);}['EchoTest'](fnCallback){var payloadObject={};payloadObject['URL']='CustomerManager/SendKeepAlives',payloadObject['OutboundDataPacket']={'TimeWindowSeconds':this['_KeepAliveTimeWindowSeconds'],'TestMode':!![]},payloadObject['InboundDataFunction']=function(CSendKeepAlivesResponse){CSendKeepAlivesResponse&&(CSendKeepAlivesResponse['Success']&&fnCallback());},payloadObject['ErrorHandlerFunction']=function(request,status,error){setTimeout(this['KeepAliveCheckingAlgorithm'],this['_KeepAliveTimeWindowSeconds']*0x3e8);},TriSysAPI['Data']['PostToWebAPI'](payloadObject);}['SendMessage'](sSenderSubscriberID,sRecipientSubscriberID,sMessage){if(!this['m_Socket'])return;const bUseWebAPI=!![];if(bUseWebAPI){var payloadObject={};payloadObject['URL']='OfficeAutomation/SendInterProcessCommunicationMessage',payloadObject['OutboundDataPacket']={'Recipient':sRecipientSubscriberID,'Sender':sSenderSubscriberID,'Message':sMessage},payloadObject['InboundDataFunction']=function(CSendInterProcessCommunicationMessageResponse){if(CSendInterProcessCommunicationMessageResponse){if(CSendInterProcessCommunicationMessageResponse['Success']){var sMessage='We\x20sent\x20the\x20inter-process\x20communication\x20message\x20to\x20'+sRecipientSubscriberID+'\x20from\x20'+sSenderSubscriberID;console['log'](sMessage);}}},TriSysAPI['Data']['PostToWebAPI'](payloadObject);}else{const dataToSend={'Sender':sSenderSubscriberID,'Recipient':sRecipientSubscriberID,'MessageJSON':sMessage};fetch(this['ServerURL']+'/message/send',{'method':'POST','headers':{'Content-Type':'application/json'},'body':JSON['stringify'](dataToSend)})['then'](response=>response['json']())['then'](data=>{if(this['MessageSentCallback'])this['MessageSentCallback']('Success:',data);})['catch'](error=>{if(this['MessageSendErrorCallback'])this['MessageSendErrorCallback']('Error:',error);});}}}