var ctrlExportToPayroll={'MarkTimesheetAsPaid':'ctrlExportToPayroll-MarkTimesheetAsPaid','RecipientContact':'ctrlExportToPayroll_Contact','RecipientCompany':'ctrlExportToPayroll_Company','RecipientAddress':'ctrlExportToPayroll_Address','GroupByRequirement':'ctrlExportToPayroll-GroupByRequirement','InsertHeaderAndFooter':'ctrlExportToPayroll-InsertHeaderAndFooter','MergeToPDF':'ctrlExportToPayroll-MergeToPDF','CoversheetTemplateID':'ctrlExportToPayroll-Coversheet','TimesheetTemplateID':'ctrlExportToPayroll-Timesheet','EMailTemplateID':'ctrlExportToPayroll-Template','EditCoversheetTemplateButtonID':'ctrlExportToPayroll-EditCoversheetTemplate','EditTimesheetTemplateButtonID':'ctrlExportToPayroll-EditTimesheetTemplate','EditTemplateButtonID':'ctrlExportToPayroll-EditTemplate','SubjectID':'ctrlExportToPayroll-Subject','NoteHistoryID':'ctrlExportToPayroll-NoteHistory','FollowUpID':'ctrlExportToPayroll-FollowUp','AttachTimesheets':'ctrlExportToPayroll-AttachTimesheets','AttachmentsID':'ctrlExportToPayroll-Attachments','ManageAttachmentsButtonID':'ctrlExportToPayroll-ManageAttachmentLibrary','_Recipient_ContactId':0x0,'_TimesheetIdList':[],'Load':function(){var actionData=new TriSysActions['Invocation']['ActionData']();actionData['RecordIdentifierList']&&($('#ctrlExportToPayroll-TimesheetCount')['html'](actionData['RecordIdentifierList']['length']),ctrlExportToPayroll['_TimesheetIdList']=actionData['RecordIdentifierList']);var sPayrollFolder='Payroll/',sExportToPayroll='Export\x20to\x20Payroll',sExportToPayrollFolder=sPayrollFolder+sExportToPayroll+'\x20E-Mail/';TriSysActions['MailMerge']['PopulateTemplates'](sExportToPayroll,sExportToPayrollFolder,ctrlExportToPayroll['EMailTemplateID'],sExportToPayroll,ctrlExportToPayroll['EditTemplateButtonID']);var sExportToPayrollCoversheetFolder=sPayrollFolder+sExportToPayroll+'\x20Cover\x20Sheets/';TriSysActions['MailMerge']['PopulateTemplates'](sExportToPayroll,sExportToPayrollCoversheetFolder,ctrlExportToPayroll['CoversheetTemplateID'],'Coversheet',ctrlExportToPayroll['EditCoversheetTemplateButtonID']);var sExportToPayrollTimesheetFolder=sPayrollFolder+sExportToPayroll+'\x20Timesheets/';TriSysActions['MailMerge']['PopulateTemplates'](sExportToPayroll,sExportToPayrollTimesheetFolder,ctrlExportToPayroll['TimesheetTemplateID'],'Timesheet',ctrlExportToPayroll['EditTimesheetTemplateButtonID']);var defaults={'TaskType':'Letter'};TriSysActions['NoteHistory']['Load'](ctrlExportToPayroll['NoteHistoryID'],defaults);var dtFollowUp=TriSysActions['FollowUp']['FollowUpDateTomorrow']();defaults={'CreateFollowUp':!![],'StartDateTime':dtFollowUp},TriSysActions['FollowUp']['Load'](ctrlExportToPayroll['FollowUpID'],defaults),TriSysActions['Persistence']['Read'](ctrlExportToPayroll['ReadPersistedSettingsCallback']);},'AssignContactLink':function(){var fnSelectContact=function(selectedRow){if(!selectedRow)return;var lContactId=selectedRow['ContactId'],lCompanyId=selectedRow['CompanyId'],lAddressId=selectedRow['AddressId'],sContactName=selectedRow['Christian']+'\x20'+selectedRow['Surname'],sCompany=selectedRow['Name'],sAddress=selectedRow['Street']+'\x0a'+selectedRow['City']+'\x0a'+selectedRow['County']+'\x0a'+selectedRow['PostCode'];return ctrlExportToPayroll['_Recipient_ContactId']=lContactId,$('#'+ctrlExportToPayroll['RecipientContact'])['val'](sContactName),$('#'+ctrlExportToPayroll['RecipientCompany'])['val'](sCompany+'\x0a'+sAddress),!![];};TriSysApex['ModalDialogue']['ClientContacts']['Select'](fnSelectContact);},'Configure':function(){var mySettings=ctrlExportToPayroll['GetSettings']();if(!mySettings)return;TriSysActions['Persistence']['Write'](mySettings);},'GetSettings':function(){var sError=null,bMarkTimesheetAsPaid=TriSysSDK['CShowForm']['GetCheckBoxValue'](ctrlExportToPayroll['MarkTimesheetAsPaid']),bGroupByRequirement=TriSysSDK['CShowForm']['GetCheckBoxValue'](ctrlExportToPayroll['GroupByRequirement']),bInsertHeaderAndFooter=TriSysSDK['CShowForm']['GetCheckBoxValue'](ctrlExportToPayroll['InsertHeaderAndFooter']),sCoversheetTemplate=TriSysActions['MailMerge']['GetTemplateFromCombo'](ctrlExportToPayroll['CoversheetTemplateID']),bMergeToPDF=TriSysSDK['CShowForm']['GetCheckBoxValue'](ctrlExportToPayroll['MergeToPDF']),sEMailTemplate=TriSysActions['MailMerge']['GetTemplateFromCombo'](ctrlExportToPayroll['EMailTemplateID']),sSubject=$('#'+ctrlExportToPayroll['SubjectID'])['val'](),bAttachTimesheets=TriSysSDK['CShowForm']['GetCheckBoxValue'](ctrlExportToPayroll['AttachTimesheets']),sTimesheetTemplate=TriSysActions['MailMerge']['GetTemplateFromCombo'](ctrlExportToPayroll['TimesheetTemplateID']);if(sError)return TriSysApex['UI']['ShowMessage'](sError),null;var mySettings={'MarkTimesheetAsPaid':bMarkTimesheetAsPaid,'GroupByRequirement':bGroupByRequirement,'InsertHeaderAndFooter':bInsertHeaderAndFooter,'CoversheetTemplate':sCoversheetTemplate,'TimesheetTemplate':sTimesheetTemplate,'MergeToPDF':bMergeToPDF,'EMailTemplate':sEMailTemplate,'Subject':sSubject,'AttachTimesheets':bAttachTimesheets,'NoteHistory':ctrlNoteHistory['Validation'](),'FollowUp':ctrlFollowUp['Validation'](),'ContactId':ctrlExportToPayroll['_Recipient_ContactId'],'ContactName':$('#'+ctrlExportToPayroll['RecipientContact'])['val'](),'Company':$('#'+ctrlExportToPayroll['RecipientCompany'])['val']()};return mySettings;},'ReadPersistedSettingsCallback':function(mySettings){TriSysSDK['CShowForm']['SetCheckBoxValue'](ctrlExportToPayroll['MarkTimesheetAsPaid'],mySettings['MarkTimesheetAsPaid']),TriSysSDK['CShowForm']['SetCheckBoxValue'](ctrlExportToPayroll['GroupByRequirement'],mySettings['GroupByRequirement']),TriSysSDK['CShowForm']['SetCheckBoxValue'](ctrlExportToPayroll['InsertHeaderAndFooter'],mySettings['InsertHeaderAndFooter']),TriSysSDK['CShowForm']['SetCheckBoxValue'](ctrlExportToPayroll['MergeToPDF'],mySettings['MergeToPDF']),TriSysSDK['CShowForm']['SetCheckBoxValue'](ctrlExportToPayroll['AttachTimesheets'],mySettings['AttachTimesheets']),TriSysSDK['CShowForm']['SetTextInCombo'](ctrlExportToPayroll['CoversheetTemplateID'],mySettings['CoversheetTemplate']),TriSysSDK['CShowForm']['SetTextInCombo'](ctrlExportToPayroll['TimesheetTemplateID'],mySettings['TimesheetTemplate']),TriSysSDK['CShowForm']['SetTextInCombo'](ctrlExportToPayroll['EMailTemplateID'],mySettings['EMailTemplate']),$('#'+ctrlExportToPayroll['SubjectID'])['val'](mySettings['Subject']),TriSysActions['PersistedSettingsSafeguard']['WaitUntilTaskControlsAreLoaded'](!![],!![],function(){ctrlNoteHistory['Reload'](mySettings['NoteHistory']),ctrlFollowUp['Reload'](mySettings['FollowUp']);}),ctrlExportToPayroll['_Recipient_ContactId']=mySettings['ContactId'],$('#'+ctrlExportToPayroll['RecipientContact'])['val'](mySettings['ContactName']),$('#'+ctrlExportToPayroll['RecipientCompany'])['val'](mySettings['Company']);},'MailMergeData':function(){var sCompany=$('#'+ctrlExportToPayroll['RecipientCompany'])['val']();if(sCompany){var parts=sCompany['split']('\x0a');sCompany=parts[0x0];}var actionSpecificData={'ActionName':'ExportToPayroll','ActionDisplayName':'Export\x20to\x20Payroll','Values':[{'FieldName':'RecipientContactId','FieldDisplayName':'ContactId','Value':ctrlExportToPayroll['_Recipient_ContactId']},{'FieldName':'RecipientName','FieldDisplayName':'FullName','Value':$('#'+ctrlExportToPayroll['RecipientContact'])['val']()},{'FieldName':'RecipientCompany','FieldDisplayName':'Company','Value':sCompany},{'FieldName':'TimesheetCount','FieldDisplayName':'TimesheetCount','Value':ctrlExportToPayroll['_TimesheetIdList']['length']},{'FieldName':'PlacementCount','FieldDisplayName':'Placement\x20Count','Value':0x1},{'FieldName':'TimesheetIndex','FieldDisplayName':'Timesheet\x20Index','Value':0x1},{'FieldName':'TimesheetId','FieldDisplayName':'TimesheetId','Value':'12345678'},{'FieldName':'CompanyName','FieldDisplayName':'CompanyName','Value':'Acme\x20Widgets'},{'FieldName':'PeriodEnding','FieldDisplayName':'PeriodEnding','Value':'Sunday\x2030\x20July\x202017'},{'FieldName':'PeriodName','FieldDisplayName':'PeriodName','Value':'Week'},{'FieldName':'SiteAddress','FieldDisplayName':'SiteAddress','Value':'Wellington\x20House<br\x20/>East\x20Road<br\x20/>Cambridge<br\x20/>CB1\x207XA'},{'FieldName':'JobReference','FieldDisplayName':'JobReference','Value':'Req/000381'},{'FieldName':'PONumber','FieldDisplayName':'PONumber','Value':'PO/12345/000381'},{'FieldName':'Candidate','FieldDisplayName':'Candidate','Value':'Julie\x20Adams'},{'FieldName':'JobTitle','FieldDisplayName':'JobTitle','Value':'Professor\x20of\x20Particle\x20Physics'},{'FieldName':'ApprovedByName','FieldDisplayName':'ApprovedByName','Value':'Lizzie\x20McGuire'},{'FieldName':'ApprovedByPosition','FieldDisplayName':'ApprovedByPosition','Value':'Doctor\x20of\x20Newtonian\x20Mechanics'},{'FieldName':'ApprovedDate','FieldDisplayName':'ApprovedDate','Value':'Monday\x2031\x20July\x202017'},{'FieldName':'ApprovedTime','FieldDisplayName':'ApprovedTime','Value':'10:07'},{'FieldName':'AuthorisedIPAddress','FieldDisplayName':'Authorised\x20IP\x20Address','Value':'123.456.789.012'},{'FieldName':'rate1-type','FieldDisplayName':'Rate\x201\x20Name','Value':'Standard'},{'FieldName':'rate1-notes','FieldDisplayName':'Rate\x201\x20Notes','Value':'Mon-Fri\x209am-6pm'},{'FieldName':'rate1-pay','FieldDisplayName':'Rate\x201\x20Pay','Value':'£8.50\x20per\x20hour'},{'FieldName':'rate2-type','FieldDisplayName':'Rate\x202\x20Name','Value':'Overtime\x201'},{'FieldName':'rate2-notes','FieldDisplayName':'Rate\x202\x20Notes','Value':'Mon-Fri\x20after\x206pm'},{'FieldName':'rate2-pay','FieldDisplayName':'Rate\x202\x20Pay','Value':'£9.50\x20per\x20hour'},{'FieldName':'rate3-type','FieldDisplayName':'Rate\x203\x20Name','Value':'Overtime\x202'},{'FieldName':'rate3-notes','FieldDisplayName':'Rate\x203\x20Notes','Value':'Saturday'},{'FieldName':'rate3-pay','FieldDisplayName':'Rate\x203\x20Pay','Value':'£11.50\x20per\x20hour'},{'FieldName':'rate4-type','FieldDisplayName':'Rate\x204\x20Name','Value':'Overtime\x203'},{'FieldName':'rate4-notes','FieldDisplayName':'Rate\x204\x20Notes','Value':'Sunday'},{'FieldName':'rate4-pay','FieldDisplayName':'Rate\x204\x20Pay','Value':'£12.50\x20per\x20hour'}]},dtStart=new Date('2017/07/03');for(var iDay=0x0;iDay<=0x23;iDay++){var dtNoo=new Date(dtStart['getFullYear'](),dtStart['getMonth'](),dtStart['getDate']()+iDay),sDay=moment(dtNoo)['format']('ddd\x20DD\x20MMM\x20YYYY'),value={'FieldName':'period'+(iDay+0x1)+'-name','FieldDisplayName':'period'+(iDay+0x1)+'-name','Value':sDay};actionSpecificData['Values']['push'](value);}for(var iDay=0x1;iDay<=0x23;iDay++){var fTotal=0x0;for(var iRate=0x1;iRate<=0x4;iRate++){var sFieldName='period'+iDay+'-rate'+iRate,fValue=iDay/0x2+iRate;fTotal+=fValue;var value={'FieldName':sFieldName,'FieldDisplayName':sFieldName,'Value':fValue};actionSpecificData['Values']['push'](value);}var value={'FieldName':'period'+iDay+'-total','FieldDisplayName':'period'+iDay+'-total','Value':fTotal};actionSpecificData['Values']['push'](value);}for(var iRate=0x1;iRate<=0x4;iRate++){var sFieldName='rate'+iRate+'-total',fValue=iRate,value={'FieldName':sFieldName,'FieldDisplayName':sFieldName,'Value':fValue};actionSpecificData['Values']['push'](value);}var value={'FieldName':'total-hours','FieldDisplayName':'total-hours','Value':54.3};return actionSpecificData['Values']['push'](value),actionSpecificData;},'Finish':function(){var mySettings=ctrlExportToPayroll['GetSettings']();if(!mySettings)return;var NoteHistoryData=ctrlNoteHistory['Validation']();if(!NoteHistoryData)return;var FollowUpData=ctrlFollowUp['Validation']();if(!FollowUpData)return;var sError=null;if(!mySettings['CoversheetTemplate'])sError='You\x20must\x20send\x20a\x20coversheet.';else{if(!mySettings['TimesheetTemplate'])sError='You\x20must\x20choose\x20a\x20timesheet\x20template.';else{if(!mySettings['EMailTemplate'])sError='You\x20must\x20choose\x20an\x20e-mail\x20template.';else{if(!mySettings['Subject'])sError='You\x20must\x20enter\x20an\x20e-mail\x20subject.';}}}if(sError)return TriSysApex['UI']['ShowMessage'](sError),null;ctrlExportToPayroll['SendActionDataToWebAPI'](mySettings,NoteHistoryData,FollowUpData);},'SendActionDataToWebAPI':function(mySettings,NoteHistoryData,FollowUpData){var CExportToPayrollActionRequest={'MarkTimesheetAsPaid':mySettings['MarkTimesheetAsPaid'],'GroupByRequirement':mySettings['GroupByRequirement'],'InsertHeaderAndFooter':mySettings['InsertHeaderAndFooter'],'MergeToPDF':mySettings['MergeToPDF'],'AttachTimesheets':mySettings['AttachTimesheets'],'CoversheetTemplate':mySettings['CoversheetTemplate'],'TimesheetTemplate':mySettings['TimesheetTemplate'],'EMailTemplate':mySettings['EMailTemplate'],'Subject':mySettings['Subject'],'RecipientContactId':mySettings['ContactId'],'ActionData':new TriSysActions['Invocation']['ActionData'](),'NoteHistory':NoteHistoryData,'FollowUp':FollowUpData},payloadObject={};payloadObject['URL']='Action/ExportTimesheetsToPayroll',payloadObject['OutboundDataPacket']=CExportToPayrollActionRequest,payloadObject['InboundDataFunction']=function(CExportToPayrollActionResponse){TriSysApex['UI']['HideWait']();if(CExportToPayrollActionResponse){if(CExportToPayrollActionResponse['Success']){TriSysActions['Invocation']['PostInvocationCompletion']();if(CExportToPayrollActionResponse['URL'])for(var i=0x0;i<CExportToPayrollActionResponse['URL']['length'];i++){var sURL=CExportToPayrollActionResponse['URL'][i];TriSysApex['ModalDialogue']['DocumentViewer']['DownloadAndOpen']('e-mail',sURL);}return;}else TriSysApex['UI']['ShowMessage'](CExportToPayrollActionResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['HideWait'](),TriSysApex['UI']['errorAlert']('ctrlExportToPayroll.SendActionDataToWebAPI:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysApex['UI']['ShowWait'](null,'Generating\x20E-Mail...'),TriSysAPI['Data']['PostToWebAPI'](payloadObject);}};$(document)['ready'](function(){ctrlExportToPayroll['Load']();});