var ctrlSendEMail={'CurrentEMailClientSideMessage':null,'SenderEMail':null,'Load':function(){var userCredentials=TriSysApex['LoginCredentials']['UserCredentials'](),userContact=userCredentials['LoggedInUser']['Contact'],sFromEMail=userContact['WorkEMail'];$('#ctrlSendEMail-From')['html'](sFromEMail),TriSysSDK['CShowForm']['populateMultiSelectComboFromDataSource']('ctrlSendEMail-To',null),TriSysSDK['CShowForm']['populateMultiSelectComboFromDataSource']('ctrlSendEMail-Cc',null),TriSysSDK['CShowForm']['populateMultiSelectComboFromDataSource']('ctrlSendEMail-Bcc',null),TriSysSDK['CShowForm']['populateMultiSelectComboFromDataSource']('ctrlSendEMail-Attachments',null),ctrlSendEMail['InitialiseDocumentEditor'](),$('#ctrlSendEMail-AddTo')['on']('click',function(){ctrlSendEMail['LookupContactEMail']('ctrlSendEMail-To');}),$('#ctrlSendEMail-AddCc')['on']('click',function(){ctrlSendEMail['LookupContactEMail']('ctrlSendEMail-Cc');}),$('#ctrlSendEMail-AddBcc')['on']('click',function(){ctrlSendEMail['LookupContactEMail']('ctrlSendEMail-Bcc');}),$('#ctrlSendEMail-AddAttachment')['on']('click',function(){ctrlSendEMail['AddAttachmentFile']('ctrlSendEMail-Attachments');}),$('#ctrlSendEMail-Editor-Preview-Checkbox')['on']('click',function(){var bShowPreview=$(this)['is'](':checked');$('#ctrlSendEMail-Editor-Container')['toggle'](),$('#ctrlSendEMail-Editor-Frame')['toggle'](),ctrlSendEMail['SynchroniseEditorAndPreview']();}),TriSysActions['Forms']['TaskType']['Load']('ctrlSendEMail-TaskType','ctrlSendEMail-Selected-TaskType-Image','E-Mail'),$('#ctrlSendEMail-Create-NoteHistory')['on']('click',ctrlSendEMail['OnCreateNoteHistoryClickEvent']);var options=TriSysActions['EMail']['EMailClientSideOptions'];options&&(options['SuppressNoteHistory']&&($('#ctrlSendEMail-NoteHistoryGroup')['hide'](),TriSysSDK['CShowForm']['SetCheckBoxValue']('ctrlSendEMail-Create-NoteHistory',![]))),ctrlSendEMail['LoadNextMessageInSequence'](),TriSysActions['SMTPChecking']['PreventContinueWithoutSMTPCredentials']('E-Mail\x20Action');},'LoadEMailMessage':function(emailMessage){$('#ctrlSendEMail-Subject')['val'](emailMessage['Subject']),ctrlSendEMail['SenderEMail']=emailMessage['Sender'];if(emailMessage['Sender'])$('#ctrlSendEMail-From')['html'](emailMessage['Sender']);ctrlSendEMail['PopulateMultiSelectField']('ctrlSendEMail-To',emailMessage['ToRecipients']),ctrlSendEMail['PopulateMultiSelectField']('ctrlSendEMail-Cc',emailMessage['CcRecipients']),ctrlSendEMail['PopulateMultiSelectField']('ctrlSendEMail-Bcc',emailMessage['BccRecipients']),ctrlSendEMail['PopulateMultiSelectField']('ctrlSendEMail-Attachments',emailMessage['Attachments'],!![]),ctrlSendEMail['PopulateEditorHTML'](emailMessage['HTML']),ctrlSendEMail['PopulateViewer'](emailMessage['HTML']);},'PopulateMultiSelectField':function(sFieldID,lstItems,bDisplayFileNameOnly){var sFieldList='',sourceItems=[];if(lstItems)for(var i=0x0;i<lstItems['length'];i++){var sItem=lstItems[i],sDisplayItem=sItem;if(bDisplayFileNameOnly)sDisplayItem=ctrlSendEMail['FileNameFromURL'](sDisplayItem);var sourceStruct={'value':sItem,'text':sDisplayItem};sourceItems['push'](sourceStruct);if(sFieldList['length']>0x0)sFieldList+=',\x20';sFieldList+=sDisplayItem;}TriSysSDK['CShowForm']['replaceItemsInMultiSelectCombo'](sFieldID,sourceItems),sFieldList&&TriSysSDK['CShowForm']['SetSkillsInList'](sFieldID,sFieldList);},'FileNameFromURL':function(sURL){if(sURL){var iLastSlash=sURL['lastIndexOf']('\x5c');if(iLastSlash>=0x0){var sFile=sURL['substring'](iLastSlash+0x1);return sFile;}else return TriSysSDK['Controls']['FileManager']['GetFileNameFromPath'](sURL);}},'InitialiseDocumentEditor':function(){var iFrameID='ctrlSendEMail-Editor-Frame',frame_element=document['getElementById'](iFrameID);frame_element['style']['height']='1px';var iKludgeFactor=0xb4,iFrameHeight=$(window)['height']()*0.77-iKludgeFactor;frame_element['style']['height']=iFrameHeight+'px';var editorID='#ctrlSendEMail-Editor',iEditorHeight=iFrameHeight,editorObject=$(editorID);editorObject['height'](iEditorHeight),editorObject['kendoEditor']({'tools':['bold','italic','underline','strikethrough','justifyLeft','justifyCenter','justifyRight','justifyFull','createLink','unlink','insertImage','createTable','addColumnLeft','addColumnRight','addRowAbove','addRowBelow','deleteRow','deleteColumn','formatting','cleanFormatting','fontName','fontSize','foreColor','backColor','print',TriSysSDK['KendoUIEditor']['Fonts']]}),ctrlSendEMail['EditorTag']=editorObject['data']('kendoEditor');try{var elem=document['getElementsByClassName']('k-widget\x20k-editor\x20k-header\x20k-editor-widget');elem&&(elem[0x0]['style']['border']='0');}catch(e){}},'EditorTag':null,'PopulateEditorHTML':function(sHTML){try{if(ctrlSendEMail['EditorTag'])ctrlSendEMail['EditorTag']['value'](sHTML);}catch(e){TriSysApex['Logging']['LogMessage']('ctrlSendEMail.PopulateEditorHTML:\x20Error:\x20'+TriSysApex['Logging']['CatchVariableToText'](e));}},'PopulateViewer':function(sHTML){var sFrameID='ctrlSendEMail-Editor-Frame',frame_element=document['getElementById'](sFrameID);if(!frame_element)return;var iframeElementContainer=frame_element['contentDocument'];iframeElementContainer['open'](),iframeElementContainer['writeln'](sHTML),iframeElementContainer['close']();},'GetEditedHTML':function(){if(ctrlSendEMail['EditorTag']){var sHTML=ctrlSendEMail['EditorTag']['value']();return sHTML;}},'SynchroniseEditorAndPreview':function(){var bShowPreview=TriSysSDK['CShowForm']['GetCheckBoxValue']('ctrlSendEMail-Editor-Preview-Checkbox',![]);if(bShowPreview){var sHTML=ctrlSendEMail['GetEditedHTML']();ctrlSendEMail['PopulateViewer'](sHTML);}},'LookupContactEMail':function(sFieldID){TriSysApex['Pages']['ContactForm']['OpenFindDialogue'](function(lContactId){return setTimeout(function(){ctrlSendEMail['ChooseEMailAddressOfSelectedContact'](sFieldID,lContactId);},0xfa),!![];});},'ChooseEMailAddressOfSelectedContact':function(sFieldID,lContactId){TriSysApex['ModalDialogue']['ContactEMailAddress']['Select'](lContactId,function(sTypeOfEMail,sEMailAddress){var existingValues=TriSysSDK['CShowForm']['GetSelectedSkillsFromList'](sFieldID);TriSysSDK['CShowForm']['addItemToMultiSelectCombo'](sFieldID,sEMailAddress,sEMailAddress);if(existingValues)existingValues+=',\x20';return existingValues+=sEMailAddress,TriSysSDK['CShowForm']['SetSkillsInList'](sFieldID,existingValues),!![];});},'AddAttachmentFile':function(sFieldID){var fnAddFile=function(sFilePath){if(!ctrlSendEMail['CurrentEMailClientSideMessage'])ctrlSendEMail['CurrentEMailClientSideMessage']={'Attachments':null};if(!ctrlSendEMail['CurrentEMailClientSideMessage']['Attachments'])ctrlSendEMail['CurrentEMailClientSideMessage']['Attachments']=[];ctrlSendEMail['CurrentEMailClientSideMessage']['Attachments']['push'](sFilePath);var existingValues=TriSysSDK['CShowForm']['GetSelectedSkillsFromList'](sFieldID),sName=TriSysSDK['Controls']['FileManager']['GetFileNameFromPath'](sFilePath);TriSysSDK['CShowForm']['addItemToMultiSelectCombo'](sFieldID,sFilePath,sName);if(existingValues)existingValues+=',\x20';existingValues+=sName,TriSysSDK['CShowForm']['SetSkillsInList'](sFieldID,existingValues);};TriSysSDK['Controls']['FileManager']['FindFileUpload']('E-Mail\x20Attachment',fnAddFile);},'Send':function(){var sHTML=ctrlSendEMail['GetEditedHTML'](),toArray=TriSysSDK['CShowForm']['GetSelectedSkillsFromListAsArray']('ctrlSendEMail-To'),ccArray=TriSysSDK['CShowForm']['GetSelectedSkillsFromListAsArray']('ctrlSendEMail-Cc'),bccArray=TriSysSDK['CShowForm']['GetSelectedSkillsFromListAsArray']('ctrlSendEMail-Bcc'),sSubject=$('#ctrlSendEMail-Subject')['val'](),attachmentsArray=TriSysSDK['CShowForm']['GetSelectedSkillsFromListAsArray']('ctrlSendEMail-Attachments'),bCreateNoteHistory=ctrlSendEMail['CreateNoteHistory'](),sTaskType=TriSysSDK['CShowForm']['GetTaskTypeFromCombo']('ctrlSendEMail-TaskType'),sNotes=$('#ctrlSendEMail-Notes')['val'](),sError=null,iRecipientCount=0x0;if(toArray)iRecipientCount+=toArray['length'];if(ccArray)iRecipientCount+=ccArray['length'];if(bccArray)iRecipientCount+=bccArray['length'];if(iRecipientCount==0x0)sError='No\x20recipients.';else{if(!sSubject)sError='No\x20subject.';else{if(!sHTML)sError='No\x20content.';else{if(bCreateNoteHistory&&!sNotes)sError='No\x20notes.';}}}if(sError)return TriSysApex['UI']['ShowMessage'](sError),![];var attachmentPathArray=null;if(attachmentsArray){attachmentPathArray=[];var emailMessage=ctrlSendEMail['CurrentEMailClientSideMessage'];for(var i=0x0;i<attachmentsArray['length'];i++){var sDisplayItem=attachmentsArray[i],bFound=![],sAttachment=null;if(emailMessage['Attachments'])for(var j=0x0;j<emailMessage['Attachments']['length'];j++){sAttachment=emailMessage['Attachments'][j];if(sDisplayItem==ctrlSendEMail['FileNameFromURL'](sAttachment)){bFound=!![];break;}}if(bFound)attachmentPathArray['push'](sAttachment);}}var NoteHistoryData={'CreateNoteHistory':bCreateNoteHistory,'TaskType':sTaskType,'Notes':sNotes},CSendEMailRequest={'HTML':sHTML,'Subject':sSubject,'Attachments':attachmentPathArray,'ToRecipients':toArray,'CcRecipients':ccArray,'BccRecipients':bccArray,'NoteHistory':NoteHistoryData,'ActionData':new TriSysActions['Invocation']['ActionData']()};if(ctrlSendEMail['SenderEMail'])CSendEMailRequest['Sender']=ctrlSendEMail['SenderEMail'];ctrlSendEMail['SendEMailToWebAPI'](CSendEMailRequest);if(TriSysActions['EMail']['EMailClientSideMessages']['length']==0x0)return!![];},'SendEMailToWebAPI':function(CSendEMailRequest){var payloadObject={};payloadObject['URL']='EMail/Send',payloadObject['OutboundDataPacket']=CSendEMailRequest;var bAsynchronousMailMerge=![];payloadObject['InboundDataFunction']=function(CSendEMailResponse){if(!bAsynchronousMailMerge)TriSysApex['UI']['HideWait']();if(CSendEMailResponse){if(CSendEMailResponse['Success']){var sMessage='E-Mail\x20successfuly\x20sent.';TriSysApex['Toasters']['Success'](sMessage);if(TriSysActions['Invocation']['InvokedActionID']=='EMail')TriSysActions['Invocation']['PostInvocationCompletion']();else ctrlSendEMail['LoadNextMessageInSequence']();return;}else{var sError='Your\x20e-mail\x20has\x20failed\x20to\x20send.'+'<br\x20/>'+'This\x20is\x20possibly\x20because\x20your\x20SMTP\x20settings\x20are\x20not\x20correct,\x20or\x20the\x20recipient/sender\x20e-mail\x20address\x20is\x20invalid.'+'<br\x20/>'+'SMTP\x20settings:\x20'+CSendEMailResponse['SMTPSummary']+'<br\x20/>'+'Sender\x20E-Mail:\x20'+TriSysSDK['Miscellaneous']['EscapeHTML'](CSendEMailResponse['SenderEMail'])+'<br\x20/>'+'Recipient\x20E-Mail:\x20'+CSendEMailResponse['RecipientEMail']+'<br\x20/>'+'This\x20is\x20the\x20error\x20received\x20from\x20the\x20specified\x20SMTP\x20server:'+'<br\x20/>'+CSendEMailResponse['ErrorMessage'];if(CSendEMailResponse['InvalidRecipient']){sError=CSendEMailResponse['InvalidRecipient'],TriSysApex['UI']['ShowMessage'](sError);return;}TriSysApex['UI']['ShowError'](sError);}}},payloadObject['ErrorHandlerFunction']=function(request,status,error){if(!bAsynchronousMailMerge)TriSysApex['UI']['HideWait']();TriSysApex['UI']['errorAlert']('ctrlSendEMail.SendEMailToWebAPI:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);};if(bAsynchronousMailMerge){var fnCloseAction=function(){return setTimeout(TriSysApex['UI']['CloseModalPopup'],0x64),!![];};TriSysApex['UI']['ShowMessage']('E-Mail\x20Send\x20has\x20been\x20scheduled.','E-Mail\x20Send',fnCloseAction);}else TriSysApex['UI']['ShowWait'](null,'Sending\x20E-Mail...');TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'SendAllRemaining':function(){if(!ctrlSendEMail['CurrentEMailClientSideMessage']||!TriSysActions['EMail']['EMailClientSideMessages'])return![];var sSubject=$('#ctrlSendEMail-Subject')['val'](),bCreateNoteHistory=ctrlSendEMail['CreateNoteHistory'](),sNotes=$('#ctrlSendEMail-Notes')['val'](),sError=null;if(!sSubject)sError='No\x20subject.';else{if(bCreateNoteHistory&&!sNotes)sError='No\x20notes.';}if(sError)return TriSysApex['UI']['ShowMessage'](sError),![];TriSysActions['EMail']['EMailClientSideMessages']['push'](ctrlSendEMail['CurrentEMailClientSideMessage']);var iNumberOfEMailMessages=TriSysActions['EMail']['EMailClientSideMessages']['length'],sFormattedNumber=TriSysSDK['Numbers']['ThousandsSeparator'](iNumberOfEMailMessages),CSendMultipleEMailRequest={'MailMessages':TriSysActions['EMail']['EMailClientSideMessages']},payloadObject={};payloadObject['URL']='EMail/SendMultiple',payloadObject['OutboundDataPacket']=CSendMultipleEMailRequest;var bAsynchronousMailMerge=![];payloadObject['InboundDataFunction']=function(CSendMultipleEMailResponse){if(!bAsynchronousMailMerge)TriSysApex['UI']['HideWait']();if(CSendMultipleEMailResponse){if(CSendMultipleEMailResponse['Success']){var sMessage=sFormattedNumber+'\x20E-Mail\x20messages\x20successfuly\x20sent.';TriSysApex['Toasters']['Success'](sMessage);return;}else TriSysApex['UI']['ShowMessage'](CSendMultipleEMailResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){if(!bAsynchronousMailMerge)TriSysApex['UI']['HideWait']();TriSysApex['UI']['errorAlert']('ctrlSendEMail.SendAllRemaining:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);};if(bAsynchronousMailMerge){var fnCloseAction=function(){return setTimeout(TriSysApex['UI']['CloseModalPopup'],0x64),!![];};TriSysApex['UI']['ShowMessage']('E-Mail\x20Send\x20has\x20been\x20scheduled.','E-Mail\x20Send',fnCloseAction);}else TriSysApex['UI']['ShowWait'](null,'Sending\x20'+sFormattedNumber+'\x20E-Mails...');return TriSysAPI['Data']['PostToWebAPI'](payloadObject),!![];},'LoadNextMessageInSequence':function(){var iNumberOfEMailMessages=TriSysActions['EMail']['EMailClientSideMessages']['length'];if(TriSysActions['Invocation']['InvokedActionID']=='EMail'){ctrlSendEMail['NewAdHocMessage']();return;}if(iNumberOfEMailMessages==0x0){TriSysActions['Invocation']['PostInvocationCompletion']();return;}ctrlSendEMail['CurrentEMailClientSideMessage']=TriSysActions['EMail']['EMailClientSideMessages'][0x0],TriSysActions['EMail']['EMailClientSideMessages']['splice'](0x0,0x1),ctrlSendEMail['LoadEMailMessage'](ctrlSendEMail['CurrentEMailClientSideMessage']);var sCaption='Send\x20All\x20'+TriSysSDK['Numbers']['ThousandsSeparator'](iNumberOfEMailMessages)+'\x20E-Mail\x20Messages';if(iNumberOfEMailMessages==0x2)sCaption='Send\x20Last\x20Two\x20E-Mail\x20Messages';$('#trisys-modal-warning')['text'](sCaption);if(iNumberOfEMailMessages<=0x1)$('#trisys-modal-warning')['hide']();},'OnCreateNoteHistoryClickEvent':function(){var bCreateNoteHistory=ctrlSendEMail['CreateNoteHistory']();bCreateNoteHistory?($('#ctrlSendEMail-TaskType-tr')['show'](),$('#ctrlSendEMail-Notes-tr')['show']()):($('#ctrlSendEMail-TaskType-tr')['hide'](),$('#ctrlSendEMail-Notes-tr')['hide']());},'CreateNoteHistory':function(){var bCreateNoteHistory=TriSysSDK['CShowForm']['CheckBoxValue']('ctrlSendEMail-Create-NoteHistory');return bCreateNoteHistory;},'NewAdHocMessage':function(){var sCaption='Send';$('#trisys-modal-warning')['text'](sCaption),$('#ctrlSendEMail-Editor-Preview-Checkbox')['trigger']('click');var sWaiting='<p\x20style=\x22color:\x20gray;\x20font-size:\x2011px;\x22>Preparing\x20e-mail\x20message...</p>';ctrlSendEMail['PopulateEditorHTML'](sWaiting),ctrlSendEMail['PopulateViewer'](sWaiting);var fnDisplayMessage=function(message){ctrlSendEMail['CurrentEMailClientSideMessage']=message,TriSysActions['EMail']['EMailClientSideMessages']=[],ctrlSendEMail['LoadEMailMessage'](ctrlSendEMail['CurrentEMailClientSideMessage']),setTimeout(function(){},0x64);},fnPopulateRecipients=function(contacts){var lstToRecipients=[],lstBCCRecipients=[];if(contacts){var lstRecipients=contacts['length']==0x1?lstToRecipients:lstBCCRecipients;for(var i=0x0;i<contacts['length'];i++){var contact=contacts[i],sEMail=contact['ContactType']=='Candidate'?contact['PersonalEMail']:contact['WorkEMail'];if(sEMail)lstRecipients['push'](sEMail);}}var message={'Subject':'','HTML':'Reading...','ToRecipients':lstToRecipients,'BccRecipients':lstBCCRecipients};ctrlSendEMail['MergeSignatureFile'](message,fnDisplayMessage);};ctrlSendEMail['PopulateActionData'](fnPopulateRecipients);},'SendAdHocEMail':function(){ctrlSendEMail['Send']();},'PopulateActionData':function(fnCallback){var CReadMailMergeDetailsActionRequest=new TriSysActions['Invocation']['ActionData'](),payloadObject={};payloadObject['URL']='Action/ReadMailMergeDetails',payloadObject['OutboundDataPacket']=CReadMailMergeDetailsActionRequest,payloadObject['InboundDataFunction']=function(CReadMailMergeDetailsActionResponse){TriSysApex['UI']['HideWait']();if(CReadMailMergeDetailsActionResponse){if(CReadMailMergeDetailsActionResponse['Success']){fnCallback(CReadMailMergeDetailsActionResponse['Contacts']);return;}else TriSysApex['UI']['ShowMessage'](CReadMailMergeDetailsActionResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['HideWait'](),TriSysApex['UI']['errorAlert']('ctrlSendEMail.PopulateActionData:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysApex['UI']['ShowWait'](null,'Reading\x20Contacts...'),TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'MergeSignatureFile':function(message,fnCallback){var CMergeSignatureFileActionRequest={'File':'Master/E-Mail'},payloadObject={};payloadObject['URL']='Action/MergeSignatureFile',payloadObject['OutboundDataPacket']=CMergeSignatureFileActionRequest,payloadObject['InboundDataFunction']=function(CMergeSignatureFileActionResponse){if(CMergeSignatureFileActionResponse){if(CMergeSignatureFileActionResponse['Success']){message['HTML']=CMergeSignatureFileActionResponse['HTML'],fnCallback(message);return;}else TriSysApex['UI']['ShowMessage'](CMergeSignatureFileActionResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['errorAlert']('ctrlSendEMail.MergeSignatureFile:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysAPI['Data']['PostToWebAPI'](payloadObject);}};$(document)['ready'](function(){ctrlSendEMail['Load']();});