var ctrlMeeting={'ContactID':'ctrlMeeting-Contact','LocationID':'ctrlMeeting-Location','NewLocationID':'ctrlMeeting-NewLocation','StartDateTimeID':'ctrlMeeting-StartDateTime','TaskTypeID':'ctrlMeeting-TaskType','TaskTypeImage':'ctrlMeeting-Selected-TaskType-Image','AttributesID':'ctrlMeeting-Attributes','DurationID':'ctrlMeeting-Duration','SetAlarmID':'ctrlMeeting-Set-Alarm','LeadTimeID':'ctrlMeeting-LeadTime','FollowUpID':'ctrlMeeting-FollowUp','NotesID':'ctrlMeeting-Notes','TemplatesID':'ctrlMeeting-Template','EditTemplateButtonID':'ctrlMeeting-EditTemplate','SubjectID':'ctrlMeeting-Subject','AttachmentsID':'ctrlMeeting-Attachments','ManageAttachmentsButtonID':'ctrlMeeting-ManageAttachmentLibrary','BlindCopyID':'ctrlMeeting-BlindCopy','CompanyId':0x0,'CompanyName':null,'Load':function(){ctrlMeeting['GatherMeetingDetails'](),TriSysActions['Forms']['TaskType']['Load'](ctrlMeeting['TaskTypeID'],ctrlMeeting['TaskTypeImage'],'Meeting'),TriSysActions['Forms']['Attributes']['Load'](ctrlMeeting['AttributesID']),TriSysSDK['CShowForm']['dateTimePicker'](ctrlMeeting['StartDateTimeID']),TriSysSDK['Controls']['Duration']['Initialise'](ctrlMeeting['DurationID']),TriSysSDK['Controls']['Duration']['Initialise'](ctrlMeeting['LeadTimeID']);var dtMeeting=TriSysActions['FollowUp']['FollowUpDateTomorrow'](),dtFollowUp=new Date(moment(dtMeeting)['add'](0x1,'days'));setTimeout(function(){TriSysSDK['CShowForm']['setDateTimePickerValue'](ctrlMeeting['StartDateTimeID'],dtMeeting),TriSysSDK['Controls']['Duration']['Set'](ctrlMeeting['DurationID'],'2\x20hours'),TriSysSDK['Controls']['Duration']['Set'](ctrlMeeting['LeadTimeID'],'3\x20hours');},0x3e8);var defaults={'CreateFollowUp':!![],'StartDateTime':dtFollowUp};TriSysActions['FollowUp']['Load'](ctrlMeeting['FollowUpID'],defaults);var fnAlarm=function(){var bSetAlarm=$('#'+ctrlMeeting['SetAlarmID'])['is'](':checked');if(bSetAlarm)$('#ctrlMeeting-LeadTime-tr')['show']();else $('#ctrlMeeting-LeadTime-tr')['hide']();};$('#'+ctrlMeeting['SetAlarmID'])['on']('click',function(){fnAlarm();}),$('#'+ctrlMeeting['NewLocationID'])['on']('click',function(){ctrlMeeting['SpecifyNewMeetingLocation']();});var sMeeting='Meeting',sMeetingFolder=sMeeting+'/';TriSysActions['MailMerge']['PopulateTemplates'](sMeeting,TriSysActions['MailMerge']['MasterTemplateFolder']+sMeetingFolder,ctrlMeeting['TemplatesID'],'Client\x20Meeting',ctrlMeeting['EditTemplateButtonID']),TriSysActions['MailMerge']['PopulateAttachments'](ctrlMeeting['AttachmentsID'],ctrlMeeting['ManageAttachmentsButtonID']),TriSysActions['Persistence']['Read'](ctrlMeeting['ReadPersistedSettingsCallback']);},'GatherMeetingDetails':function(){var CReadMeetingDetailsRequest=new TriSysActions['Invocation']['ActionData'](),payloadObject={};payloadObject['URL']='Action/ReadMeetingDetails',payloadObject['OutboundDataPacket']=CReadMeetingDetailsRequest,payloadObject['InboundDataFunction']=function(CReadMeetingDetailsResponse){TriSysApex['UI']['HideWait']();if(CReadMeetingDetailsResponse){if(CReadMeetingDetailsResponse['Success']){ctrlMeeting['DisplayMeetingDetails'](CReadMeetingDetailsResponse);return;}else TriSysApex['UI']['ShowMessage'](CReadMeetingDetailsResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['HideWait'](),TriSysApex['UI']['errorAlert']('ctrlMeeting.GatherMeetingDetails:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysApex['UI']['ShowWait'](null,'Reading\x20Contact(s)...'),TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'DisplayMeetingDetails':function(CReadMeetingDetailsResponse){var companyAddresses=[],addresses=CReadMeetingDetailsResponse['Addresses'],iSelectedIndex=0x0;if(addresses)for(var i=0x0;i<addresses['length'];i++){var address=addresses[i],sAddressDisplay=TriSysSDK['Miscellaneous']['EllipsisText'](address['Display'],0x64);companyAddresses['push']({'value':address['AddressId'],'text':sAddressDisplay});if(address['AddressId']==CReadMeetingDetailsResponse['DefaultAddressId'])iSelectedIndex=i;}TriSysSDK['CShowForm']['populateComboFromDataSource'](ctrlMeeting['LocationID'],companyAddresses,iSelectedIndex),TriSysActions['MailMerge']['DisplayContactDetails'](CReadMeetingDetailsResponse['Contacts'],ctrlMeeting['ContactID']),ctrlMeeting['CompanyId']=CReadMeetingDetailsResponse['CompanyId'],ctrlMeeting['CompanyName']=CReadMeetingDetailsResponse['CompanyName'];},'SpecifyNewMeetingLocation':function(){var fnNewAddress=function(lCompanyId,lContactId,address){var sStreet=address['Street']['replace'](/\r\n/g,',\x20')['replace'](/\n/g,',\x20'),sAddress=sStreet+(address['City']?',\x20'+address['City']:'')+(address['County']?',\x20'+address['County']:'')+(address['PostCode']?',\x20'+address['PostCode']:'');TriSysSDK['CShowForm']['addItemToCombo'](ctrlMeeting['LocationID'],sAddress,!![]),TriSysApex['UI']['CloseModalPopup']();},options={'Title':'Meeting\x20Location','HideCompanyBlock':!![]};TriSysApex['ModalDialogue']['NewCompanyAddress']['Popup'](ctrlMeeting['CompanyId'],ctrlMeeting['CompanyName'],0x0,0x0,fnNewAddress,![],options);},'MailMergeData':function(){var sAttributes=TriSysSDK['CShowForm']['GetSelectedSkillsFromList'](ctrlMeeting['AttributesID']),sLocation=TriSysSDK['CShowForm']['GetTextFromCombo'](ctrlMeeting['LocationID']),sTaskType=TriSysSDK['CShowForm']['GetTaskTypeFromCombo'](ctrlMeeting['TaskTypeID']),sStartDate=TriSysSDK['CShowForm']['getDateTimePickerValue'](ctrlMeeting['StartDateTimeID'],'dddd\x20DD\x20MMMM\x20YYYY'),sStartTime=TriSysSDK['CShowForm']['getDateTimePickerValue'](ctrlMeeting['StartDateTimeID'],'HH:mm'),sDuration=TriSysSDK['Controls']['Duration']['Get'](ctrlMeeting['DurationID']),sNotes=$('#'+ctrlMeeting['NotesID'])['val'](),lAddressId=TriSysSDK['CShowForm']['GetValueFromCombo'](ctrlMeeting['LocationID']),actionSpecificData={'ActionName':'Meeting','ActionDisplayName':'Meeting','Values':[{'FieldName':'TaskType','FieldDisplayName':'Task\x20Type','Value':sTaskType},{'FieldName':'Date','FieldDisplayName':'Date','Value':sStartDate},{'FieldName':'Time','FieldDisplayName':'Time','Value':sStartTime},{'FieldName':'AddressId','FieldDisplayName':'Address\x20ID','Value':lAddressId},{'FieldName':'Location','FieldDisplayName':'Location\x20Address','Value':sLocation},{'FieldName':'MapURL','FieldDisplayName':'Map\x20URL','Value':''},{'FieldName':'Duration','FieldDisplayName':'Duration','Value':sDuration},{'FieldName':'Notes','FieldDisplayName':'Notes','Value':sNotes}]};return actionSpecificData;},'Finish':function(){var mySettings=ctrlMeeting['GetSettings']();if(!mySettings)return;var NoteHistoryData={'Scheduled':!![],'TaskType':mySettings['TaskType'],'Attributes':mySettings['Attributes'],'Notes':mySettings['Notes'],'StartDateTime':mySettings['Start'],'Duration':mySettings['Duration'],'Alarmed':mySettings['Alarmed'],'AlarmLeadTime':mySettings['AlarmLeadTime']},FollowUpData=ctrlFollowUp['Validation']();if(!FollowUpData)return;FollowUpData['Attributes']=mySettings['Attributes'],ctrlMeeting['SendActionDataToWebAPI'](mySettings['Template'],mySettings['Subject'],mySettings['Attachments'],mySettings['BlindCopy'],NoteHistoryData,FollowUpData);},'SendActionDataToWebAPI':function(sTemplate,sSubject,sAttachments,bBlindCopy,NoteHistoryData,FollowUpData){var CMeetingActionRequest={'Template':sTemplate,'Subject':sSubject,'Attachments':sAttachments,'BlindCopy':bBlindCopy,'ActionData':new TriSysActions['Invocation']['ActionData'](),'NoteHistory':NoteHistoryData,'FollowUp':FollowUpData},payloadObject={};payloadObject['URL']='Action/Meeting',payloadObject['OutboundDataPacket']=CMeetingActionRequest,payloadObject['InboundDataFunction']=function(CMeetingActionResponse){TriSysApex['UI']['HideWait']();if(CMeetingActionResponse){if(CMeetingActionResponse['Success']){TriSysActions['Invocation']['PostInvocationCompletion']();if(CMeetingActionResponse['URL'])for(var i=0x0;i<CMeetingActionResponse['URL']['length'];i++){var sURL=CMeetingActionResponse['URL'][i];TriSysApex['ModalDialogue']['DocumentViewer']['DownloadAndOpen']('e-mail',sURL);}else{if(CMeetingActionResponse['MailMessages']){if(CMeetingActionResponse['MailMessages']['length']>0x0)TriSysActions['EMail']['SendDialogue'](CMeetingActionResponse['MailMessages']);}}return;}else TriSysApex['UI']['ShowMessage'](CMeetingActionResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['HideWait'](),TriSysApex['UI']['errorAlert']('ctrlMeeting.SendActionDataToWebAPI:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysApex['UI']['ShowWait'](null,'Scheduling\x20Meeting...'),TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'GetSettings':function(){var sAttributes=TriSysSDK['CShowForm']['GetSelectedSkillsFromList'](ctrlMeeting['AttributesID']),sLocation=TriSysSDK['CShowForm']['GetTextFromCombo'](ctrlMeeting['LocationID']),sTaskType=TriSysSDK['CShowForm']['GetTaskTypeFromCombo'](ctrlMeeting['TaskTypeID']),dtStart=TriSysSDK['CShowForm']['getDateTimePickerValue'](ctrlMeeting['StartDateTimeID']),sStartDate=TriSysSDK['CShowForm']['getDateTimePickerValue'](ctrlMeeting['StartDateTimeID'],'dddd\x20DD\x20MMMM\x20YYYY'),sStartTime=TriSysSDK['CShowForm']['getDateTimePickerValue'](ctrlMeeting['StartDateTimeID'],'HH:mm'),sDuration=TriSysSDK['Controls']['Duration']['Get'](ctrlMeeting['DurationID']),bAlarmed=TriSysSDK['CShowForm']['CheckBoxValue'](ctrlMeeting['SetAlarmID']),sAlarmLeadTime=TriSysSDK['Controls']['Duration']['Get'](ctrlMeeting['LeadTimeID']),sNotes=$('#'+ctrlMeeting['NotesID'])['val'](),sTemplate=TriSysActions['MailMerge']['GetTemplateFromCombo'](ctrlMeeting['TemplatesID']),sSubject=$('#'+ctrlMeeting['SubjectID'])['val'](),sAttachments=TriSysSDK['CShowForm']['GetSelectedSkillsFromList'](ctrlMeeting['AttachmentsID']),bBCC=TriSysSDK['CShowForm']['GetCheckBoxValue'](ctrlMeeting['BlindCopyID'],![]),sError=null;if(!sStartDate||!sStartTime)sError='Please\x20enter\x20the\x20meeting\x20date/time.';else{if(!sLocation)sError='Please\x20enter\x20a\x20location\x20for\x20the\x20meeting.';}if(sError)return TriSysApex['UI']['ShowMessage'](sError),null;var mySettings={'TaskType':sTaskType,'Attributes':sAttributes,'Notes':sNotes,'Start':dtStart,'Duration':sDuration,'Alarmed':bAlarmed,'AlarmLeadTime':sAlarmLeadTime,'Template':sTemplate,'Subject':sSubject,'Attachments':sAttachments,'BlindCopy':bBCC,'FollowUp':ctrlFollowUp['Validation']()};return mySettings;},'ReadPersistedSettingsCallback':function(mySettings){mySettings&&(TriSysSDK['CShowForm']['SetTaskTypeComboValue'](ctrlMeeting['TaskTypeID'],mySettings['TaskType']),TriSysActions['Forms']['TaskType']['Icon'](ctrlMeeting['TaskTypeID'],ctrlMeeting['TaskTypeImage']),TriSysSDK['CShowForm']['SetSkillsInList'](ctrlMeeting['AttributesID'],mySettings['Attributes']),TriSysSDK['CShowForm']['SetTextInCombo'](ctrlMeeting['TemplatesID'],mySettings['Template']),TriSysSDK['CShowForm']['SetSkillsInList'](ctrlMeeting['AttachmentsID'],mySettings['Attachments']),TriSysSDK['Controls']['Duration']['Set'](ctrlMeeting['DurationID'],mySettings['Duration']),$('#'+ctrlMeeting['NotesID'])['val'](mySettings['Notes']),$('#'+ctrlMeeting['SubjectID'])['val'](mySettings['Subject']),TriSysSDK['CShowForm']['SetCheckBoxValue'](ctrlMeeting['BlindCopyID'],mySettings['BlindCopy']),TriSysActions['PersistedSettingsSafeguard']['WaitUntilTaskControlsAreLoaded'](![],!![],function(){ctrlFollowUp['Reload'](mySettings['FollowUp']);}));},'Configure':function(){var mySettings=ctrlMeeting['GetSettings']();if(!mySettings)return;TriSysActions['Persistence']['Write'](mySettings);}};$(document)['ready'](function(){ctrlMeeting['Load']();});