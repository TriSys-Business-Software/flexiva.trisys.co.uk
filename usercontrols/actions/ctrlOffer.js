var ctrlOffer={'ClientID':'ctrlOffer-Client','RequirementID':'ctrlOffer-Requirement','CandidateID':'ctrlOffer-Candidate','ClientTemplatesID':'ctrlOffer-ClientTemplate','CandidateTemplatesID':'ctrlOffer-CandidateTemplate','EditClientTemplateButtonID':'ctrlOffer-EditClientTemplate','EditCandidateTemplateButtonID':'ctrlOffer-EditCandidateTemplate','ClientSubjectID':'ctrlOffer-ClientSubject','CandidateSubjectID':'ctrlOffer-CandidateSubject','StartDateID':'ctrlOffer-StartDate','EndDateID':'ctrlOffer-EndDate','SalaryID':'ctrlOffer-Salary','NoteHistoryID':'ctrlOffer-NoteHistory','FollowUpID':'ctrlOffer-FollowUp','CandidateList':null,'Load':function(){var sOffer='OfferMade',sOfferFolder=sOffer+'/';TriSysActions['MailMerge']['PopulateTemplates'](sOffer+':\x20Client',TriSysActions['MailMerge']['MasterTemplateFolder']+sOfferFolder+TriSysActions['MailMerge']['ClientTemplatesFolder'],ctrlOffer['ClientTemplatesID'],'Client\x20Offer',ctrlOffer['EditClientTemplateButtonID']),TriSysActions['MailMerge']['PopulateTemplates'](sOffer+':\x20Candidate',TriSysActions['MailMerge']['MasterTemplateFolder']+sOfferFolder+TriSysActions['MailMerge']['CandidateTemplatesFolder'],ctrlOffer['CandidateTemplatesID'],'Candidate\x20Offer',ctrlOffer['EditCandidateTemplateButtonID']);var defaults={'TaskType':'Letter'};TriSysActions['NoteHistory']['Load'](ctrlOffer['NoteHistoryID'],defaults),TriSysSDK['CShowForm']['datePicker'](ctrlOffer['StartDateID']),TriSysSDK['CShowForm']['datePicker'](ctrlOffer['EndDateID']);var fSpinIncrement=0x1f4,sPeriod='Annum';TriSysSDK['Controls']['CurrencyAmountPeriod']['PopulateCurrencyAmountPeriodWidget'](ctrlOffer['SalaryID'],fSpinIncrement,sPeriod);var dtFollowUp=TriSysActions['FollowUp']['FollowUpDateTomorrow']();defaults={'CreateFollowUp':!![],'StartDateTime':dtFollowUp},TriSysActions['FollowUp']['Load'](ctrlOffer['FollowUpID'],defaults),ctrlOffer['PopulateActionData']();},'PopulateActionData':function(){if(TriSysActions['Invocation']['SingletonContactListCheck']('Offer','candidate'))return;var CReadCVSendDetailsActionRequest=new TriSysActions['Invocation']['ActionData'](),payloadObject={};payloadObject['URL']='Action/ReadCVSendDetails',payloadObject['OutboundDataPacket']=CReadCVSendDetailsActionRequest,payloadObject['InboundDataFunction']=function(CReadCVSendDetailsActionResponse){TriSysApex['UI']['HideWait']();if(CReadCVSendDetailsActionResponse){if(CReadCVSendDetailsActionResponse['Success']){ctrlOffer['DisplayClientContactDetails'](CReadCVSendDetailsActionResponse['ClientContact']),ctrlOffer['DisplayCandidateDetails'](CReadCVSendDetailsActionResponse['CandidateContacts']),ctrlOffer['DisplayRequirementDetails'](CReadCVSendDetailsActionResponse['Requirement']);if(CReadCVSendDetailsActionResponse['Requirement'])TriSysSDK['CShowForm']['setDatePickerValue'](ctrlOffer['StartDateID'],CReadCVSendDetailsActionResponse['Requirement']['EarliestStartDate']);TriSysActions['Persistence']['Read'](ctrlOffer['ReadPersistedSettingsCallback']);return;}else TriSysApex['UI']['ShowMessage'](CReadCVSendDetailsActionResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['HideWait'](),TriSysApex['UI']['errorAlert']('ctrlOffer.PopulateActionData:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysApex['UI']['ShowWait'](null,'Reading\x20Contacts...'),TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'DisplayClientContactDetails':function(contact){var sContact=contact['FullName'];if(contact['CompanyName'])sContact+=',\x20'+contact['CompanyName'];$('#'+ctrlOffer['ClientID'])['html'](sContact);},'DisplayCandidateDetails':function(contactList){ctrlOffer['CandidateList']=contactList;var sContact='';if(contactList&&contactList['length']==0x1){var contact=contactList[0x0];sContact=contact['FullName'];if(contact['HomeAddressStreet'])sContact+=',\x20'+contact['HomeAddressStreet']['replace'](/\r\n/g,',\x20');if(contact['HomeAddressCity'])sContact+=',\x20'+contact['HomeAddressCity'];}else{if(contactList)for(var i=0x0;i<contactList['length'];i++){var contact=contactList[i];if(sContact['length']>0x0)sContact+=',\x20';sContact+=contact['FullName'];}}$('#'+ctrlOffer['CandidateID'])['html'](sContact);},'DisplayRequirementDetails':function(requirement){if(requirement){$('#'+ctrlOffer['RequirementID'])['html'](requirement['Reference']+':\x20'+requirement['JobTitle']);if(requirement['Type']=='Permanent')TriSysSDK['Controls']['CurrencyAmountPeriod']['SetCurrencyAmountPeriod'](ctrlOffer['SalaryID'],requirement['Salary']),$('#ctrlOffer-EndDate-tr')['hide']();else $('#ctrlOffer-Salary-tr')['hide']();}else $('#ctrlOffer-Requirement-tr')['hide']();},'Configure':function(){var mySettings=ctrlOffer['GetSettings']();if(!mySettings)return;TriSysActions['Persistence']['Write'](mySettings);},'GetSettings':function(){var sError=null,sClientTemplate=TriSysActions['MailMerge']['GetTemplateFromCombo'](ctrlOffer['ClientTemplatesID']),sCandidateTemplate=TriSysActions['MailMerge']['GetTemplateFromCombo'](ctrlOffer['CandidateTemplatesID']),sClientSubject=$('#'+ctrlOffer['ClientSubjectID'])['val'](),sCandidateSubject=$('#'+ctrlOffer['CandidateSubjectID'])['val']();if(sError)return TriSysApex['UI']['ShowMessage'](sError),null;var mySettings={'ClientTemplate':sClientTemplate,'CandidateTemplate':sCandidateTemplate,'ClientSubject':sClientSubject,'CandidateSubject':sCandidateSubject,'NoteHistory':ctrlNoteHistory['Validation'](),'FollowUp':ctrlFollowUp['Validation']()};return mySettings;},'ReadPersistedSettingsCallback':function(mySettings){TriSysSDK['CShowForm']['SetTextInCombo'](ctrlOffer['ClientTemplatesID'],mySettings['ClientTemplate']),TriSysSDK['CShowForm']['SetTextInCombo'](ctrlOffer['CandidateTemplatesID'],mySettings['CandidateTemplate']),$('#'+ctrlOffer['ClientSubjectID'])['val'](mySettings['ClientSubject']),$('#'+ctrlOffer['CandidateSubjectID'])['val'](mySettings['CandidateSubject']),TriSysActions['PersistedSettingsSafeguard']['WaitUntilTaskControlsAreLoaded'](!![],!![],function(){ctrlNoteHistory['Reload'](mySettings['NoteHistory']),ctrlFollowUp['Reload'](mySettings['FollowUp']);});},'MailMergeData':function(){if(!ctrlOffer['CandidateList'])return;var dtStart=TriSysSDK['CShowForm']['getDatePickerValue'](ctrlOffer['StartDateID']),sFormatedStartDate=dtStart?moment(dtStart)['format']('dddd\x20DD\x20MMMM\x20YYYY'):null,dtEnd=TriSysSDK['CShowForm']['getDatePickerValue'](ctrlOffer['EndDateID']),sFormatedEndDate=dtEnd?moment(dtEnd)['format']('dddd\x20DD\x20MMMM\x20YYYY'):null,sSalary=TriSysSDK['Controls']['CurrencyAmountPeriod']['GetCurrencyAmountPeriod'](ctrlOffer['SalaryID'],!![]),actionSpecificData={'ActionName':'Offer','ActionDisplayName':'Offer','Values':[{'FieldName':'StartDate','FieldDisplayName':'Start\x20Date','Value':sFormatedStartDate},{'FieldName':'EndDate','FieldDisplayName':'End\x20Date','Value':sFormatedEndDate},{'FieldName':'Salary','FieldDisplayName':'Salary','Value':sSalary}]};return actionSpecificData;},'Finish':function(){var mySettings=ctrlOffer['GetSettings']();if(!mySettings)return;var NoteHistoryData=ctrlNoteHistory['Validation']();if(!NoteHistoryData)return;var FollowUpData=ctrlFollowUp['Validation']();if(!FollowUpData)return;var sError=null,dtStart=TriSysSDK['CShowForm']['getDatePickerValue'](ctrlOffer['StartDateID']),dtEnd=TriSysSDK['CShowForm']['getDatePickerValue'](ctrlOffer['EndDateID']);if(!dtStart)sError='Please\x20specify\x20a\x20start\x20date.';else{var bVisible=$('#'+ctrlOffer['EndDateID'])['is'](':visible');if(bVisible){if(!dtEnd)sError='Please\x20specify\x20an\x20end\x20date.';}}if(sError)return TriSysApex['UI']['ShowMessage'](sError),null;ctrlOffer['SendActionDataToWebAPI'](mySettings,NoteHistoryData,FollowUpData);},'SendActionDataToWebAPI':function(mySettings,NoteHistoryData,FollowUpData){var COfferActionRequest={'ClientTemplate':mySettings['ClientTemplate'],'CandidateTemplate':mySettings['CandidateTemplate'],'ClientSubject':mySettings['ClientSubject'],'CandidateSubject':mySettings['CandidateSubject'],'ActionData':new TriSysActions['Invocation']['ActionData'](),'NoteHistory':NoteHistoryData,'FollowUp':FollowUpData},payloadObject={};payloadObject['URL']='Action/Offer',payloadObject['OutboundDataPacket']=COfferActionRequest,payloadObject['InboundDataFunction']=function(COfferActionResponse){TriSysApex['UI']['HideWait']();if(COfferActionResponse){if(COfferActionResponse['Success']){TriSysActions['Invocation']['PostInvocationCompletion']();if(COfferActionResponse['URL'])for(var i=0x0;i<COfferActionResponse['URL']['length'];i++){var sURL=COfferActionResponse['URL'][i];TriSysApex['ModalDialogue']['DocumentViewer']['DownloadAndOpen']('e-mail',sURL);}return;}else TriSysApex['UI']['ShowMessage'](COfferActionResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['HideWait'](),TriSysApex['UI']['errorAlert']('ctrlOffer.SendActionDataToWebAPI:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysApex['UI']['ShowWait'](null,'Generating\x20E-Mail...'),TriSysAPI['Data']['PostToWebAPI'](payloadObject);}};$(document)['ready'](function(){ctrlOffer['Load']();});