var ctrlCall={'ContactDetailsID':'ctrlCall-Contact','PhoneNumberID':'ctrlCall-PhoneNumber','DialID':'ctrlCall-Dial','HyperlinkID':'ctrlCall-DialHyperlink','SkypeID':'ctrlCall-Skype','OutcomeID':'ctrlCall-Outcome','TaskTypeID':'ctrlCall-TaskType','TaskTypeImage':'ctrlCall-Selected-TaskType-Image','DurationID':'ctrlCall-Duration','AttributesID':'ctrlCall-Attributes','FollowUpID':'ctrlCall-FollowUp','NotesID':'ctrlCall-Notes','RequirementRowID':'ctrlCall-Requirement-Row','RequirementDetails':'ctrlCall-Requirement','Contact':null,'RequirementId':0x0,'Load':function(){ctrlCall['PopulateContactPhoneNumbers'](),$('#'+ctrlCall['DialID'])['on']('click',ctrlCall['DialNumber']),TriSysSDK['CShowForm']['skillCombo'](ctrlCall['OutcomeID'],'Call\x20Outcome','Not\x20Available'),TriSysActions['Forms']['TaskType']['Load'](ctrlCall['TaskTypeID'],ctrlCall['TaskTypeImage'],'Telephone\x20Call'),TriSysSDK['Controls']['Duration']['Initialise'](ctrlCall['DurationID']);var fnLoadAttributes=function(setting){var sSkillCategory=null;if(setting)sSkillCategory=setting['Value'];var lstIncludeIgnoredSkillCategories=['Call\x20Types'];TriSysActions['Forms']['Attributes']['Load'](ctrlCall['AttributesID'],sSkillCategory,lstIncludeIgnoredSkillCategories);};TriSysApex['UserOptions']['ReadLoggedInUserSetting']('Call\x20Action:\x20Single\x20Attribute\x20Skill\x20Category',fnLoadAttributes),TriSysActions['FollowUp']['Load'](ctrlCall['FollowUpID']);var userCredentials=TriSysApex['LoginCredentials']['UserCredentials']();if(userCredentials&&userCredentials['LoggedInUser']){var bRecruitmentDatabase=TriSysAPI['Operators']['stringToBoolean'](TriSysApex['Cache']['UserSettingManager']['GetValue']('RecruitmentDatabase',![]));if(bRecruitmentDatabase){$('#'+ctrlCall['RequirementRowID'])['show']();var actionData=new TriSysActions['Invocation']['ActionData']();if(actionData['EntityName']=='Requirement'||actionData['MasterEntityName']=='Requirement'){var sRequirement=$('#RequirementConfigFields_RequirementReference')['val']();if(typeof sRequirement==='undefined')$('#'+ctrlCall['RequirementRowID'])['hide']();else sRequirement+=':\x20'+$('#RequirementConfigFields_JobTitle')['val']()+'\x20at\x20'+$('#Requirement_CompanyId')['val'](),$('#'+ctrlCall['RequirementDetails'])['val'](sRequirement),$('#ctrlCall-LinkRequirement-TableColumn')['hide']();}}}},'PopulateContactPhoneNumbers':function(){if(TriSysActions['Invocation']['SingletonContactListCheck']('Call','contact'))return;var CReadContactDetailsActionRequest=new TriSysActions['Invocation']['ActionData'](),payloadObject={};payloadObject['URL']='Action/ReadContactDetails',payloadObject['OutboundDataPacket']=CReadContactDetailsActionRequest,payloadObject['InboundDataFunction']=function(CReadContactDetailsActionResponse){TriSysApex['UI']['HideWait']();if(CReadContactDetailsActionResponse){if(CReadContactDetailsActionResponse['Success']){ctrlCall['DisplayContactDetails'](CReadContactDetailsActionResponse['Contact']),TriSysActions['Persistence']['Read'](ctrlCall['ReadPersistedSettingsCallback']);return;}else{var fnCloseActionForm=function(){return setTimeout(TriSysApex['UI']['CloseModalPopup'],0x64),!![];};TriSysApex['UI']['ShowMessage'](CReadContactDetailsActionResponse['ErrorMessage'],'Call\x20Action',fnCloseActionForm);}}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['HideWait'](),TriSysApex['UI']['errorAlert']('ctrlCall.PopulateContactPhoneNumbers:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysApex['UI']['ShowWait'](null,'Reading\x20Contact...'),TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'DisplayContactDetails':function(contact){ctrlCall['Contact']=contact;var sContact=contact['FullName'];if(contact['CompanyName'])sContact+=',\x20'+contact['CompanyName'];else{if(contact['HomeAddressStreet'])sContact+=',\x20'+contact['HomeAddressStreet'];if(contact['HomeAddressCity'])sContact+=',\x20'+contact['HomeAddressCity'];}$('#'+ctrlCall['ContactDetailsID'])['html'](sContact);var telephoneNumbers=[];if(contact['MobileTelNo'])telephoneNumbers['push']({'value':0x0,'text':'Personal\x20Mobile:\x20'+contact['MobileTelNo']});if(contact['WorkMobileTelNo'])telephoneNumbers['push']({'value':0x0,'text':'Work\x20Mobile:\x20'+contact['WorkMobileTelNo']});if(contact['HomeAddressTelNo'])telephoneNumbers['push']({'value':0x0,'text':'Home:\x20'+contact['HomeAddressTelNo']});if(contact['WorkTelNo'])telephoneNumbers['push']({'value':0x0,'text':'Work:\x20'+contact['WorkTelNo']});if(contact['SkypeNumber'])telephoneNumbers['push']({'value':0x0,'text':'Skype:\x20'+contact['SkypeNumber']});if(telephoneNumbers['length']>0x0)TriSysSDK['CShowForm']['populateComboFromDataSource'](ctrlCall['PhoneNumberID'],telephoneNumbers,0x0);else{var fnCloseActionForm=function(){return setTimeout(TriSysApex['UI']['CloseModalPopup'],0x64),!![];};TriSysApex['UI']['ShowMessage']('No\x20phone\x20numbers\x20available\x20for\x20'+contact['FullName'],'Call\x20Action',fnCloseActionForm);}},'DialNumber':function(){var sPhoneNumber=TriSysSDK['CShowForm']['GetTextFromCombo'](ctrlCall['PhoneNumberID']);if(sPhoneNumber){var parts=sPhoneNumber['split'](':\x20');sPhoneNumber=parts[0x1],ctrlCall['DialSpecifiedNumber'](sPhoneNumber);}},'DialSpecifiedNumber':function(sPhoneNumber){try{TriSysSDK['Controls']['Skype']['Call'](sPhoneNumber);return;$('#'+ctrlCall['DialID'])['hide'](),$('#'+ctrlCall['SkypeID'])['show'](),Skype['ui']({'name':'call','element':ctrlCall['SkypeID'],'participants':[sPhoneNumber],'imageSize':0x20,'imageColor':'blue'});}catch(e){TriSysApex['UI']['ShowError'](e);}},'Finish':function(){var mySettings=ctrlCall['GetSettings'](!![]);if(!mySettings)return;var FollowUpData=ctrlFollowUp['Validation']();if(!FollowUpData)return;var callActionData=new TriSysActions['Invocation']['ActionData']();callActionData['TaskType']=mySettings['TaskType'],callActionData['Attributes']=mySettings['Attributes'],callActionData['Duration']=mySettings['Duration'],callActionData['Notes']=mySettings['Notes'],callActionData['CallOutcome']=mySettings['CallOutcome'],callActionData['PhoneNumber']=mySettings['PhoneNumber'],callActionData['RequirementId']=ctrlCall['RequirementId'];if(TriSysApex['LoginCredentials']['isLoggedInToSpecificCompanyAsRecruiter']('Law\x20Absolute')){var bMissingAttributes=![];if(!callActionData['Attributes'])bMissingAttributes=!![];if(bMissingAttributes){TriSysApex['UI']['ShowMessage']('Please\x20specify\x20one\x20or\x20more\x20Attributes.');return;}if(!callActionData['Notes']){TriSysApex['UI']['ShowMessage']('Please\x20write\x20some\x20notes.');return;}}callActionData['FollowUp']=FollowUpData,ctrlCall['SendActionDataToWebAPI'](callActionData);},'SendActionDataToWebAPI':function(CCallActionRequest){var payloadObject={};payloadObject['URL']='Action/Call',payloadObject['OutboundDataPacket']=CCallActionRequest,payloadObject['InboundDataFunction']=function(CCallActionResponse){TriSysApex['UI']['HideWait']();if(CCallActionResponse){if(CCallActionResponse['Success']){TriSysActions['Invocation']['PostInvocationCompletion']();return;}else TriSysApex['UI']['ShowMessage'](CCallActionResponse['ErrorMessage']);}},payloadObject['ErrorHandlerFunction']=function(request,status,error){TriSysApex['UI']['HideWait'](),TriSysApex['UI']['errorAlert']('ctrlCall.SendActionDataToWebAPI:\x20'+status+':\x20'+error+'.\x20responseText:\x20'+request['responseText']);},TriSysApex['UI']['ShowWait'](null,'Saving\x20Call...'),TriSysAPI['Data']['PostToWebAPI'](payloadObject);},'Configure':function(){var mySettings=ctrlCall['GetSettings'](![]);if(!mySettings)return;TriSysActions['Persistence']['Write'](mySettings);},'GetSettings':function(bMandatoryFields){var sError=null,sPhoneNumber=TriSysSDK['CShowForm']['GetTextFromCombo'](ctrlCall['PhoneNumberID']),sCallOutcome=TriSysSDK['CShowForm']['GetTextFromCombo'](ctrlCall['OutcomeID']),sTaskType=TriSysSDK['CShowForm']['GetTaskTypeFromCombo'](ctrlCall['TaskTypeID']),sAttributes=TriSysSDK['CShowForm']['GetSelectedSkillsFromList'](ctrlCall['AttributesID']),sDuration=TriSysSDK['Controls']['Duration']['Get'](ctrlCall['DurationID']),sNotes=$('#'+ctrlCall['NotesID'])['val'](),bNotesMandatory=![];if(!ctrlCall['Contact']&&bMandatoryFields)sError='No\x20contact\x20is\x20selected.';else{if(!sNotes&&bNotesMandatory)sError='Please\x20enter\x20brief\x20notes\x20about\x20this\x20conversation.';}if(sError)return TriSysApex['UI']['ShowMessage'](sError),null;var mySettings={'PhoneNumber':sPhoneNumber,'CallOutcome':sCallOutcome,'TaskType':sTaskType,'Attributes':sAttributes,'Duration':sDuration,'Notes':sNotes,'FollowUp':ctrlFollowUp['Validation']()};return mySettings;},'ReadPersistedSettingsCallback':function(mySettings){TriSysSDK['CShowForm']['SetTextInCombo'](ctrlCall['OutcomeID'],mySettings['CallOutcome']),TriSysSDK['CShowForm']['SetTaskTypeComboValue'](ctrlCall['TaskTypeID'],mySettings['TaskType']),TriSysActions['Forms']['TaskType']['Icon'](ctrlCall['TaskTypeImage'],mySettings['TaskTypeImage']),TriSysSDK['CShowForm']['SetSkillsInList'](ctrlCall['AttributesID'],mySettings['Attributes']),TriSysSDK['Controls']['Duration']['Set'](ctrlCall['DurationID'],mySettings['Duration']),$('#'+ctrlCall['NotesID'])['val'](mySettings['Notes']);if(mySettings['Notes'])try{document['getElementById'](ctrlCall['NotesID'])['focus'](),document['getElementById'](ctrlCall['NotesID'])['select']();}catch(e){}TriSysActions['PersistedSettingsSafeguard']['WaitUntilTaskControlsAreLoaded'](![],!![],function(){ctrlFollowUp['Reload'](mySettings['FollowUp']);});},'RequirementLink':function(sLinkType){switch(sLinkType){case'Related':TriSysApex['ModalDialogue']['ContactRequirementSelection'](ctrlCall['Contact']['ContactId'],ctrlCall['Contact']['FullName'],ctrlCall['RequirementLookupSelectedRow']);break;case'Search':TriSysApex['ModalDialogue']['Requirements']['Select'](ctrlCall['RequirementLookupSelectedRow']);break;}},'RequirementLookupSelectedRow':function(selectedRow){if(!selectedRow)return![];var lRequirementId=selectedRow['Requirement_RequirementId'];if(lRequirementId>0x0){ctrlCall['RequirementId']=lRequirementId;var sRequirement=selectedRow['Requirement_RequirementReference']+':\x20'+selectedRow['Requirement_JobTitle']+'\x20at\x20'+selectedRow['RequirementCompany_Name'];return $('#'+ctrlCall['RequirementDetails'])['val'](sRequirement),!![];}}};$(document)['ready'](function(){ctrlCall['Load']();});